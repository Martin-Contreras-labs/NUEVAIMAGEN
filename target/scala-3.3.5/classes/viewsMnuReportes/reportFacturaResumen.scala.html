@(mapDiccionario: Map[String,String], mapPermiso: Map[String,String], userMnu: utilities.UserMnu,
desde: utilities.Fechas, hasta: utilities.Fechas, uf: Double, usd: Double, eur: Double, nroDec: Long)
    	
	<!-- ANCLA CABECERAS DE TABLAS -->
	<style type="text/css"> 
        thead tr th { 
            position: sticky;
			background-color: #eeeeee;
            top: 0;
        }
    </style>



	@main("") {

		@menues(mapDiccionario, mapPermiso, userMnu, " ")
		
		<div id="enCarga" class="blocker" style="display: block;"><br><br><br><br><br><br><h1>Ahora se esta cargando.....</h1></div>
		<div id="mostrarmostrar">
			@barraTitulo(mapDiccionario, "REPORTE RESUMEN Y DETALLE POR TODOS LOS PROYECTOS POR FAMILIA (INCLUIDOS AJUSTES DE EP)",
				"PERIODO: desde " + desde.getFechaStr() +" --- hasta: " +  hasta.getFechaStr())
				
			<div class="noprint">
				<table class="table table-sm table-condensed table-fluid">
					<tr>
						<td>
							<div align="center">
								<button type="button"  class="btn btn-sm btn-success" onclick="document.getElementById('excel').submit()">
									Exportar a Excel
								</button>
								<button type="button" class="btn btn-sm btn-success" tabindex="-1" onclick="window.print(); return false;" >
									Imprimir
								</button>
								<button type="button"  class="btn btn-sm btn-success" 
									onclick="history.go(-1);return false;">
									Volver
								</button>
							</div>
						</td>
					</tr>
				</table>
			</div>
			
			<form id="excel" class="formulario" method="post" action="/reportFacturaResumenExcel/">
				<input type="hidden" name="fechaDesde" value="@desde.getFechaSql().toString()">
				<input type="hidden" name="fechaHasta" value="@hasta.getFechaSql().toString()">
				<input type="hidden" name="uf" value="@uf">
				<input type="hidden" name="usd" value="@usd">
				<input type="hidden" name="eur" value="@eur">
			</form>
			
			
			<table id="general" class="table table-sm table-bordered table-condensed table-fluid">
				<tr>
					<td>
						<div align="left"><h5><b><font color="#008000"> RESUMEN POR PROYECTOS (INCLUYE AJUSTES A EP): </font></b></h5></div>
						
						<div id="resumenPorPJson"></div>
					</td>
				</tr>
				
				
					<tr>
						<td><br><br><br>
						@if(! mapDiccionario.get("nEmpresa").equals("SM8 DE MEXICO")) {
							<div align="left"><h5><b><font color="#008000"> RESUMEN POR FAMILIAS Y PROYECTOS (SIN AJUSTES A EP): </font></b></h5></div>
						}
							<div id="resumenPorPyGJson"></div>
						</td>
					</tr>
			
			</table>
			
		</div>
		
	}
		
		
		
		<script type="text/javascript">
		
		window.addEventListener('load', function() {
		document.getElementById('mostrarmostrar').style.display="block";
		
		
		
		let formData = new FormData();
		formData.append("fechaDesde","@desde.getFechaSql().toString()");
		formData.append("fechaHasta","@hasta.getFechaSql().toString()");
		formData.append("uf","@uf");
		formData.append("usd","@usd");
		formData.append("eur","@eur");
		$.ajax({
		    url: "/reportFacturaResumenJson/",
		    type: "POST",
		    method: "POST",
		    data: formData,
		    cache: false,
		    contentType: false,
		 	processData: false,
		 	success: function(rs){
		 		if(rs=="error"){
		 			alertify.alert('Se presento un problema o usted no tiene permisos otorgados, por favor vuelva a ingresar y si persiste el problema, contactar a soporte', function(){ 
						location.href = "/"; 
					});
		 		}else{
	
					let jsonPorPJson =rs["resumenPorPJson"];
					let jsonTotales =rs["resumenTotalesJson"];
					let jsonPorPyGJson = rs["resumenPorPyGJson"];
				vistaPrincipal(jsonPorPJson, jsonTotales, jsonPorPyGJson);
				
				}
			}
		});
		
		
	});
	
	const vistaPrincipal =(jsonPorPJson, jsonTotales, jsonPorPyGJson) =>{
		

				let tablaProyectos = ""
					+ "<table id=\"tablaProyectos\" class=\"table table-sm table-hover table-bordered table-condensed table-fluid\">"
						+ "<thead style=\"background-color: #eeeeee\">"
							+ "<TR> "
								+ "<TH style= \"text-align:center; vertical-align:top;\">SUCURSAL</TH>"
								+ "<TH style= \"text-align:center; vertical-align:top;\">NOMBRE<br>"+'@mapDiccionario.get("BODEGA")'+"/PROYECTO</TH>";
										if('@mapDiccionario.get("nEmpresa")' == "CIHLA"){
											tablaProyectos += "<TH style= \"text-align:center;vertical-align:top;\">Nro CARGO</TH>";
										}else{
											tablaProyectos += "<TH style= \"text-align:center;vertical-align:top;\">"+'@mapDiccionario.get("RUT")'+"<BR>CLIENTE</TH>"
												+ "<TH style= \"text-align:center;vertical-align:top;\">NOMBRE<BR>CLIENTE</TH>";
										}
									tablaProyectos += "<TH style= \"text-align:center; vertical-align:top;\">NOMBRE<br>PROYECTO</TH>"
											+ "<TH style= \"text-align:center; vertical-align:top;\">CFI</TH>"
											+ "<TH style= \"text-align:center; vertical-align:top;\">SubTotal<br>"+'@mapDiccionario.get("ARRIENDO")'+"</TH>"
											+ "<TH style= \"text-align:center; vertical-align:top;\">SubTotal<br>VENTA</TH>"
											+ "<TH style= \"text-align:center; vertical-align:top;\">Ajustes<BR>("+'@mapDiccionario.get("ARRIENDO")'+")</TH>"
											+ "<TH style= \"text-align:center; vertical-align:top;\">Ajustes<BR>(VENTA)</TH>"
											+ "<TH style= \"text-align:center; vertical-align:top;\">TOTAL<BR>(en "+'@mapDiccionario.get("PESOS")'+")</TH>"
								+ "</TR>"
									+ "</thead>"
										+ "<tbody>";
											for(var i in jsonPorPJson){
												tablaProyectos += "<TR>";
													for(var t in jsonTotales){
														if(jsonPorPJson[i][1] == jsonTotales[t][0]){
															tablaProyectos += "<td>"+jsonPorPJson[i][14]+"</td>"
																	+ "<td>"+jsonPorPJson[i][5]+"</td>";
																if('@mapDiccionario.get("nEmpresa")' == 'CIHLA'){
																	tablaProyectos += "<td></td>";
																}else{
																	tablaProyectos += "<td>"+jsonPorPJson[i][6]+"</td>"
																			+ "<td>"+jsonPorPJson[i][7]+"</td>";
																}
															tablaProyectos += "<td>"+jsonPorPJson[i][8]+"</td>"
											    					+ "<td style= \"text-align:right;\">"+jsonTotales[t][3]+"</td>"
											    					+ "<td style= \"text-align:right;\">"+jsonTotales[t][1]+"</td>"
											    					+ "<td style= \"text-align:right;\">"+jsonTotales[t][2]+"</td>"
											    					+ "<td style= \"text-align:right;\">"+jsonTotales[t][5]+"</td>"
											    					+ "<td style= \"text-align:right;\">"+jsonTotales[t][6]+"</td>"
											    					+ "<td style= \"text-align:right;\">"+jsonTotales[t][4]+"</td>";
														}
													}
													tablaProyectos += "</TR>";
											}
											tablaProyectos += "<TR>"
													+ "<td style=\"background-color: #eeeeee\">TOTALES</td>"
													+ "<td style=\"background-color: #eeeeee\"></td>";
												if(! '@mapDiccionario.get("nEmpresa")' == 'CIHLA'){
													tablaProyectos += "<td style=\"background-color: #eeeeee\"></td>";
												}
													tablaProyectos += "<td style=\"background-color: #eeeeee\"></td>"
															+ "<td style=\"background-color: #eeeeee\"></td>"
															+ "<td style=\"background-color: #eeeeee\"></td>";
												for(var t in jsonTotales){
													if(jsonTotales[t][0] == "SUBTOTAL"){
														tablaProyectos += "<td style=\"background-color: #eeeeee;text-align:right;\">"+jsonTotales[t][3]+"</td>"
									    					+ "<td style=\"background-color: #eeeeee;text-align:right;\">"+jsonTotales[t][1]+"</td>"
									    					+ "<td style=\"background-color: #eeeeee;text-align:right;\">"+jsonTotales[t][2]+"</td>"
									    					+ "<td style=\"background-color: #eeeeee;text-align:right;\">"+jsonTotales[t][5]+"</td>"
									    					+ "<td style=\"background-color: #eeeeee;text-align:right;\">"+jsonTotales[t][6]+"</td>"
									    					+ "<td style=\"background-color: #eeeeee;text-align:right;\">"+jsonTotales[t][4]+"</td>";
													}
												}
												tablaProyectos += "</TR>"
														+ "</tbody>"
														+ "</table>";
				document.getElementById('resumenPorPJson').innerHTML = tablaProyectos;
				
				if('@mapDiccionario.get("nEmpresa")' != "SM8 DE MEXICO") {
					let tablaFamilias = ""
	    					+ "<table id=\"tablaFamilias\" class=\"table table-sm table-hover table-bordered table-condensed table-fluid\">"
	    						+ "<thead style=\"background-color: #eeeeee\">"
	    							+ "<TR>"
	    								+ "<TH style= \"text-align:center;vertical-align:top;\">FAMILIA/GRUPO</TH>"
					+ "<TH style= \"text-align:center;vertical-align:top;\">SUCURSAL</TH>"
	    								+ "<TH style= \"text-align:center;vertical-align:top;\">"+'@mapDiccionario.get("BODEGA")'+"/PROYECTO</TH>";
	    								if(!'@mapDiccionario.get("nEmpresa")' == "CIHLA"){
	    									tablaFamilias += "<TH style= \"text-align:center;vertical-align:top;\">"+'@mapDiccionario.get("RUT")'+" CLIENTE</TH>"
	    											+ "<TH style= \"text-align:center;vertical-align:top;\">NOMBRE CLIENTE</TH>";
	    								}
	    								tablaFamilias += "<TH style= \"text-align:center;vertical-align:top;\">NOMBRE<br>PROYECTO</TH>"
	    										+ "<TH style= \"text-align:center;vertical-align:top;\">CFI (en "+'@mapDiccionario.get("PESOS")'+")</TH>"
	    										+ "<TH style= \"text-align:center;vertical-align:top;\">"+'@mapDiccionario.get("ARRIENDO")'+" (en "+'@mapDiccionario.get("PESOS")'+")</TH>"
	    										+ "<TH style= \"text-align:center;vertical-align:top;\">VENTA (en "+'@mapDiccionario.get("PESOS")'+")</TH>"
	    										+ "<TH style= \"text-align:center;vertical-align:top;\">TOTAL<BR>(en "+'@mapDiccionario.get("PESOS")'+")</TH>"
	    							+ "</TR>"
	    						+ "</thead>"
	    						+ "<tbody>";
			
			
									let totCfi = 0;
									let totArr = 0;
									let totVta = 0;
									let totTot = 0;
			
									let auxGrupo = "0";
	    							for(var i in jsonPorPyGJson){
		
										if(jsonPorPyGJson[i][0] != "") {
											auxGrupo = jsonPorPyGJson[i][0];
										}else{
											
		    								if(jsonPorPyGJson[i][3] != "SUBTOTAL" && jsonPorPyGJson[i][3] != "TOTAL"){
			
												let cfi = jsonPorPyGJson[i][4].replace(/,/g,'');
												let arr = jsonPorPyGJson[i][5].replace(/,/g,'');
												let vta = jsonPorPyGJson[i][6].replace(/,/g,'');
												let tot = jsonPorPyGJson[i][7].replace(/,/g,'');
												
												if(tot.length > 1){
													totCfi += parseFloat(cfi);
													totArr += parseFloat(arr);
													totVta += parseFloat(vta);
													totTot += parseFloat(tot);
												}
												
												
			
												tablaFamilias += "<TR>";
		    											tablaFamilias += "<td style=\"text-align:left;\">"+auxGrupo+"</td>"
														+ "<td style=\"text-align:left;\">"+jsonPorPyGJson[i][9]+"</td>"
		    											+ "<td style=\"text-align:left;\">"+jsonPorPyGJson[i][1]+"</td>";
		    											if(!'@mapDiccionario.get("nEmpresa")' == "CIHLA"){
		    												tablaFamilias += "<td style=\"text-align:left;\">"+jsonPorPyGJson[i][2]+"</td>"
		    														+ "<td style=\"text-align:left;\">"+jsonPorPyGJson[i][3]+"</td>";
		    											}
		    											tablaFamilias += "<td style=\"text-align:left;\">"+jsonPorPyGJson[i][8]+"</td>"
		    													+ "<td style=\"text-align:right;\">"+jsonPorPyGJson[i][4]+"</td>"
		    													+ "<td style=\"text-align:right;\">"+jsonPorPyGJson[i][5]+"</td>"
		    													+ "<td style=\"text-align:right;\">"+jsonPorPyGJson[i][6]+"</td>"
		    													+ "<td style=\"text-align:right;\">"+jsonPorPyGJson[i][7]+"</td>";
												tablaFamilias += "</TR>";
		    								}
						
										}
		
	    							}
	    							tablaFamilias += "</tbody><tfoot>"
											+ "<tr>"
												+ "<td>TOTALES</td>"
												+ "<td></td>"
												+ "<td></td>"
												+ "<td></td>"
												+ "<td style=\"text-align:right;\">"+formatStandar(totCfi,'@nroDec')+"</td>"
												+ "<td style=\"text-align:right;\">"+formatStandar(totArr,'@nroDec')+"</td>"
												+ "<td style=\"text-align:right;\">"+formatStandar(totVta,'@nroDec')+"</td>"
												+ "<td style=\"text-align:right;\">"+formatStandar(totTot,'@nroDec')+"</td>"
											+ "</tr>"
											+ "<tr></tr>"
	    									+ "</tfoot></table>";
						
					document.getElementById('resumenPorPyGJson').innerHTML = tablaFamilias;
				}
				
				if('@mapDiccionario.get("nEmpresa")' != "SM8 DE MEXICO"){
					var tabla = document.getElementById('tablaFamilias');
		 			tabla.deleteRow(tabla.rows.length-1);
 				 }
 				 	
		 			document.getElementById('enProceso').style.display="none";
					document.getElementById('enCarga').style.display="none";
 				 
			   }
		</script>
		
		
	
