@(mapDiccionario: Map[String,String], mapPermiso: Map[String,String], userMnu: utilities.UserMnu,
json: String, jsonRefer: String, id_proforma: Long, desde: String, hasta: String)


@main("") {

	@menues(mapDiccionario, mapPermiso, userMnu, " ")
	<div id="mostrarmostrar" style="display:none;">
		@barraTitulo(mapDiccionario, "PROFORMA FACTURA XML","COMPLETAR O MODIFICAR REFERENCIAS Y OBSERVACIONES")
		<form class="formulario" method="post" action="/generaProformaApiRelBase2/">
			<div class="container">
				<input type="hidden" name="fechaDesde" value="@desde">
				<input type="hidden" name="fechaHasta" value="@hasta">
				<input type="hidden" name="id_proforma" value="@id_proforma">
				<div id="tblReferencia"></div>
				<button type='submit'>ENVIAR</button>
			</div>
		</form>
	</div>

}
													
<script type="text/javascript">

		let jsonAux = '@json';
		jsonAux = jsonAux.replace(/\n/g, "\\n").replace(/\r/g, "\\r").replace(/&quot;/g, '"');
		let json = JSON.parse(jsonAux);

		jsonAux = '@jsonRefer';
		jsonAux = jsonAux.replace(/\n/g, "\\n").replace(/\r/g, "\\r").replace(/&quot;/g, '"');
		let jsonRefer = JSON.parse(jsonAux);
		const mapRefer = new Map(Object.entries(jsonRefer));

	$(document).ready(function() {

		let vista = "<table id=\"referencia\" class=\"table table-sm table-hover table-bordered table-condensed table-fluid\">"
						+ "<tr>"
				 			+ "<td colspan=\"4\">REFERENCIAS:</td>"
				 			+ "<td colspan=\"1\">"
				 				+ "<div align=\"right\">"
				 					+ "<a  class=\"btn btn-warning btn-mini\" onclick=\"agregarReferencia()\">agregar referencia</a>"
				 				+ "</div>"
				 			+ "</td>"
				 		+ "</tr>"
				 		+ "<tr>"
				 			+ "<td>NroLinRef</td>"
				 			+ "<td>TpoDocRef</td>"
				 			+ "<td>FolioRef</td>"
				 			+ "<td>FchRef</td>"
				 			+ "<td>RazonRef</td>"
							+ "<td>del</td>"
				 		+ "</tr>";
					if (json.references && Array.isArray(json.references) && json.references.length > 0) {
						  json.references.forEach((ref, index) => {
							let refer = mapRefer.get(""+ref.reference_id);
							vista += "<tr>"
										+ "<td>"+(index+1)+"<input type=\"hidden\" name=\"nroLinRef[]\" value=\""+(index+1)+"\"></td>"
										+ "<td>"
												 +"<select name='tpoDocRef[]' >"
													+"<option value="+ref.reference_id+">"+refer+"</option>";
												
												const listaCampos = Object.entries(jsonRefer);
												listaCampos.forEach(([campo, valor]) => {
													vista += "<option value="+campo+">"+valor+"</option>";
												});
										+ "</td>"
								vista += "</select></td>"
											+ "<td><input type=\"text\" name=\"folioRef[]\" value=\""+ref.folio_ref+"\"></td>"
											+ "<td><input type=\"date\" name=\"fchRef[]\" value=\""+ref.date_ref+"\"></td>"
											+ "<td><input type=\"text\" name=\"razonRef[]\" value=\""+ref.razon_ref+"\"></td>"
											+ "<td><a class='btn btn-mini btn-danger' onclick='eliminaReferencia(this)'>X</a></td>"
						  });
					}
					
		vista += "<table id=\"comentarios\" class=\"table table-sm table-hover table-bordered table-condensed table-fluid\">"
				 	+ "<tr>"
				 		+ "<td>OBSEVACIONES:</td>"
				 	+ "</tr>"
				 	+ "<tr>"
				 		+ "<td><textarea rows=\"4\" style=\"width:100%\" name=\"sol_observaciones\">"+json.comment+"</textarea></td>"
				 	+ "</tr>"
				+ "</table>";
					
		$("#tblReferencia").html(vista);
					
		document.getElementById('mostrarmostrar').style.display="block";
	});
	


	let eliminaReferencia = (nodo) =>{
 			nodo.parentNode.parentNode.remove();
 			let tabla = document.getElementById('referencia');
 			for (let i = 2; i < tabla.rows.length; i++){
 				let cellsOfRow = tabla.rows[i].getElementsByTagName('td');
 				cellsOfRow[0].innerHTML=i-1;
 			}
 	}
		
	function agregarReferencia(){
		var tabla = document.getElementById('referencia');
		var row = tabla.insertRow(tabla.rows.length);
		
		var cell=row.insertCell(0);
		var indice = tabla.rows.length-2;
		cell.innerHTML=indice+"<input type='hidden' name='nroLinRef[]' value='"+indice+"'>";
		
		cell=row.insertCell(1);
		var listado = "<select name='tpoDocRef[]'>";
		const listaCampos = Object.entries(jsonRefer);
		listaCampos.forEach(([campo, valor]) => {
			listado += "<option value="+campo+">"+valor+"</option>";
		});
		listado = listado + "</select>";
		cell.innerHTML=listado;
		
		cell=row.insertCell(2);
		cell.innerHTML="<input type='text' name='folioRef[]' value=''>";
		
		cell=row.insertCell(3);
		cell.innerHTML="<input type='date' name='fchRef[]' value=''>";
		
		cell=row.insertCell(4);
		cell.innerHTML="<input type='text' name='razonRef[]' value=''>";
		
		cell=row.insertCell(5);
		cell.innerHTML="<td><a class='btn btn-mini btn-danger' onclick='eliminaReferencia(this)'>X</a>";
		
	}
	
</script>
				

