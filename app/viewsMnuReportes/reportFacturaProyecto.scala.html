@(mapDiccionario: Map[String,String], mapPermiso: Map[String,String], userMnu: utilities.UserMnu,
tabla: String, fechaDesde: String, fechaHasta: String, usd: Double, eur: Double, uf: Double, 
desdeDDMMAA: String, hastaDDMMAA: String, archivoPDF: String)
    	
@main("") {

	@menues(mapDiccionario, mapPermiso, userMnu, " ")
	
	@modalContactoBodega(mapDiccionario)
	@modalContactoCliente()
	@modalContactoProyecto()
	
	<div id="enCarga" class="blocker" style="display: none;"><br><br><br><br><br><br><h1>En proceso.....<div id="msgEspera1"></div><div id="msgEspera2"></div></h1></div>
	
	<div id="mostrarmostrar" style="display:none;">
		@barraTitulo(mapDiccionario, "SELECCION DE "+mapDiccionario.get("BODEGA")+"/PROYECTO","PROCESO DE EP/FACTURACION PROFORMA")
		
		
			<div class="noprint">
				<div class="row">
					<div class="col-1"></div>
				  	<div class="col-5">
						@if(mapPermiso.get("parametro.envioMasivoProformas")!=null && mapPermiso.get("parametro.envioMasivoProformas").equals("1")){
							<button type="button"  id="btnEnvioMasivo" class="btn btn-sm btn-warning" 
								onclick="this.setAttribute('disabled', 'true'); document.getElementById('enCarga').style.display='block'; $('#modalEnvioMasivo').modal('show');">
								ENVIO MASIVO A: "Listado de Proformas"
							</button>
						}
						@if(mapPermiso.get("parametro.envioMasivoProformas")!=null && mapPermiso.get("parametro.envioMasivoProformas").equals("2")){
							<button type="button"  id="btnEnvioMasivo" class="btn btn-sm btn-warning" 
								onclick="$('#modalEnvioMasivoEnProceso').modal('show');">
								ENVIO MASIVO A: "Listado de Proformas"
							</button>
						}
						
				  	</div>
				  	<div class="col-6">
						<table class="table table-sm table-condensed table-fluid">
							<tr>
								<td>
										<button type="button"  class="btn btn-sm btn-success" onclick="document.getElementById('excel').submit()">
											Exportar a Excel
										</button>
										<button type="button" class="btn btn-sm btn-success" tabindex="-1" onclick="window.print(); return false;" >
											Imprimir
										</button>
										<button type="button"  class="btn btn-sm btn-success" 
											onclick="history.go(-1);return false;">
											Volver
										</button>
								</td>
							</tr>
						</table>
					</div>
				</div>
			</div>
			
			<form id="excel" class="formulario" method="post" action="/reportFacturaProyectoExcel/">
				<input type="hidden" name="fechaDesde" value="@fechaDesde">
				<input type="hidden" name="fechaHasta" value="@fechaHasta">
				<input type="hidden" name="uf" value="@uf">
				<input type="hidden" name="usd" value="@usd">
				<input type="hidden" name="eur" value="@eur">
			</form>
			
			
			
			
			
		<div class="row  justify-content-md-center">
			
			<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
				<div class="noprint">
					<table class="table table-sm table-condensed table-fluid">
						<tr>
							<td width="25%">
								<div class="input-group">
							  		<div class="input-group-prepend">
							    		<span class="input-group-text" id="basic-addon1">BUSCAR</span>
							  		</div>
							  		<input type="text" class="form-control left"
										id="searchTermtablaPrincipal"
										onkeyup="doSearch2_conTot('tablaPrincipal');sumarTotales();">
								</div>
							</td>
						</tr>
					</table>
				</div>
				<h5>Período desde @desdeDDMMAA a @hastaDDMMAA</h5>
				<div class="table-responsive">
					@Html(tabla)
				</div>
			</div>
		</div>
	</div>
	
	<div id='muestraPDF' class='modal' role='dialog' data-backdrop='static' data-keyboard='false'>
		<div class='modal-dialog modal-dialog-scrollable modal-lg' role='document'>
			<div class='modal-content'>
				<div class='modal-header'>
					<h5 class='modal-title'>FACTURA PROFORMA</h5>
				        <button type='button' class='close' data-dismiss='modal' aria-label='Close'>
				          <span aria-hidden='true'>&times;</span>
				        </button>
				</div>
				<div class='modal-body'>
					<div id="rutaPDF"></div>
	   				<div class='row'>
						<div class='col-sm-12' style='text-align:center'>
							<button type='button' class='btn btn-sm  btn-success' style='font-size: 10px;' data-dismiss='modal'>Listo</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div id='modalEnvioMasivo' class='modal' role='dialog' data-backdrop='static' data-keyboard='false'>
		<div class='modal-dialog modal-dialog-scrollable' role='document' style="width:300px">
			<div class='modal-content'>
				<div class='modal-header'>
					ENVIO MASIVO PROFORMAS
				        <button type='button' class='close' data-dismiss='modal' aria-label='Close'>
				          <span aria-hidden='true'>&times;</span>
				        </button>
				</div>
				<div class='modal-body'>
					<div class="input-group">

					        	
					        	<div class="input-group">
								  <div class="input-group-prepend">
								    <div class="input-group-text">
								      <input type="radio" name="optradio" checked onchange="envioDeVentas = 0;">
								    </div>
								  </div>
								  <input type="text" class="form-control" value="Envio de proformas ALQUILER" disabled>
								</div>
								
								<div class="input-group">
								  <div class="input-group-prepend">
								    <div class="input-group-text">
								      <input type="radio" name="optradio" onchange="envioDeVentas = 1;">
								    </div>
								  </div>
								  <input type="text" class="form-control" value="Envio de proformas VENTAS" disabled>
								</div>
					</div>
					<br>
					<div class='row'>
						<div class='col-sm-12' style='text-align:center'>
							<input type="button" class="btn btn-sm btn-primary" value='Enviar' onclick='envioMasivo1();' data-dismiss='modal'>
							<input type='button' class='btn btn-sm btn-warning' value='Cancelar' 
								onclick='$("#btnEnvioMasivo").prop("disabled",false); document.getElementById("enCarga").style.display="none";'
								data-dismiss='modal'>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div id='modalEnvioMasivoEnProceso' class='modal' role='dialog' data-backdrop='static' data-keyboard='false'>
		<div class='modal-dialog modal-dialog-scrollable' role='document' style="width:300px">
			<div class='modal-content'>
				<div class='modal-header'>
					ENVIO MASIVO PROFORMAS
				        <button type='button' class='close' data-dismiss='modal' aria-label='Close'>
				          <span aria-hidden='true'>&times;</span>
				        </button>
				</div>
				<div class='modal-body'>
					<div class="input-group">
			        	<p>
							No puede generar una nueva solicitud, ya existe una solicitud en proceso.
			        	</p>
					</div>
					<br>
					<div class='row'>
						<div class='col-sm-12' style='text-align:center'>
							<input type='button' class='btn btn-sm btn-warning' value='Cerrar' 
								onclick='$("#btnEnvioMasivo").prop("disabled",false);'
								data-dismiss='modal'>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>


			<form id="envioMasivoListadoProforma" class="formulario" method="post" action="/routes2/envioMasivoListadoProforma2/">
				<input type="hidden" name="fechaDesde" value="@fechaDesde">
				<input type="hidden" name="fechaHasta" value="@fechaHasta">
				<input type="hidden" name="uf" value="@uf">
				<input type="hidden" name="usd" value="@usd">
				<input type="hidden" name="eur" value="@eur">
				<input type="hidden" id="esVenta" name="esVenta" value="@eur">
				<input type="hidden" name="comentarios" value="">
			</form>


}


<script type="text/javascript">


	
	let recorrer = document.querySelectorAll(".arr").length;
	let contador = 0;
	let envioDeVentas = 0;
		
	let classArr = document.querySelectorAll(".arr");
	let classVta = document.querySelectorAll(".vta");
	let classGranTotal = document.querySelectorAll(".granTotal");
	let classIdBodega = document.querySelectorAll(".idBodega");

	let resultado = 'Creadas y enviadas con exito proformas a "Listado de Proformas" las Nros: ';

	const envioMasivo1 = () =>{
		
		document.getElementById('enCarga').style.display="block";
		
		if(envioDeVentas == 0){
			if (contador < recorrer) {
				$("#esVenta").val(envioDeVentas);
				document.getElementById('envioMasivoListadoProforma').submit();
			}else{
				alertify.alert("No existen proformas de alquiler a enviar", function () { });
				document.getElementById('enCarga').style.display="none";
			}
		}else{
			if (contador < recorrer) {
				$("#esVenta").val(envioDeVentas);
				document.getElementById('envioMasivoListadoProforma').submit();
			}else{
				alertify.alert("No existen proformas de venta a enviar", function () { });
				document.getElementById('enCarga').style.display="none";
			}
		}
		
	}
	

	let flag = true;
	$(document).ready(function() {

		 $('#tablaPrincipal').DataTable({
		    	"fixedHeader": true,
		    	"paging": false,
				"info": false,
				"searching": false,
		    	"order": [[ 2, "asc" ]],
		    	"language": {
		        	"url": "https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
		        }
		  } );
		sumarTotales();
	});

	const sumarTotales = () => {
	    let totalCFI = 0;
	    let totalARR = 0;
	    let totalVTA = 0;
	    let totalAjustArr = 0;
	    let totalAjustVta = 0;
	    let totalGranTotal = 0;
	
	    // Sumar solo celdas visibles 
	    $(".cfi:visible").each(function () {
	        totalCFI += parseFloat($(this).text().replace(/,/g, '') || 0);
	    });
	
	    $(".arr:visible").each(function () {
	        totalARR += parseFloat($(this).text().replace(/,/g, '') || 0);
	    });
	
	    $(".vta:visible").each(function () {
	        totalVTA += parseFloat($(this).text().replace(/,/g, '') || 0);
	    });
	
	    $(".ajustArr:visible").each(function () {
	        totalAjustArr += parseFloat($(this).text().replace(/,/g, '') || 0);
	    });
	
	    $(".ajustVta:visible").each(function () {
	        totalAjustVta += parseFloat($(this).text().replace(/,/g, '') || 0);
	    });
	
	    $(".granTotal:visible").each(function () {
	        totalGranTotal += parseFloat($(this).text().replace(/,/g, '') || 0);
	    });
	
	    // Actualizar los totales en la tabla
	    $("#cfi").text(formatStandar(totalCFI,0));
	    $("#arr").text(formatStandar(totalARR,0));
	    $("#vta").text(formatStandar(totalVTA,0));
	    $("#ajustArr").text(formatStandar(totalAjustArr,0));
	    $("#ajustVta").text(formatStandar(totalAjustVta,0));
	    $("#granTotal").text(formatStandar(totalGranTotal,0));
	
	    // Mostrar contenedor (CHAT GPT)
	    $("#mostrarmostrar").show();
	
	    if ("@archivoPDF" !== "0") {
	        $("#rutaPDF").html(
	            `<object data='/showPdf/@archivoPDF' type='application/pdf' width='100%' height='720'></object>`
	        );
	        $("#muestraPDF").modal("show");
	    }
	}
			
// Llamar a sumarTotales al cargar la página
	$(document).ready(() => {
	    sumarTotales();
	});
	
	
	
</script>




		
		
	
