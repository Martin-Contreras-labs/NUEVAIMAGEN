@(mapDiccionario: Map[String,String], mapPermiso: Map[String,String], userMnu: utilities.UserMnu,
qrEquipo: qr.QrEquipo, listaTransac: List[qr.QrTransacEquipo], listaCampos:List[qr.QrAtributoEquipo], listaCamposFiltrado: List[qr.QrAtributoEquipo])

    	
@main("") {

@menues(mapDiccionario, mapPermiso, userMnu, " ")
	<div id="mostrarmostrar" style="display:none;">
		@barraTitulo(mapDiccionario,"PUBLICAR DATOS AL EQUIPO -- CODIFICACION QR","CREAR/MODIFICAR/ELIMINAR")
		<div class="row  justify-content-md-center">
			<div class="col-xs-10 col-sm-8 col-md-8 col-lg-8">
				<table class="table table-bordered ">
					<TR>
						<td style='text-align:left;vertical-align:top'>
							<h5><font color="blue">CODIGO: @qrEquipo.codigo.toUpperCase()</font></h5>
							<h5><font color="blue">EQUIPO: @qrEquipo.nombre.toUpperCase()</font></h5>
						</td>
					</TR>
				</table>
				<input type="hidden" id="auxiliarDeCambio">

				<table id="tablaCampos" class="table table-sm table-hover table-bordered table-condensed table-fluid">
					<thead style="background-color: #eeeeee">
						<TR>
							<th colspan="4">ATRIBUTOS ASOCIADOS AL EQUIPO</th>
						</TR>
						<TR>
							<th hidden="true"> IdCampo</th>
							<th hidden="true"> tipo</th>
							<th>ORDEN</th>
							<th>ATRIBUTO</th>
							<th>CONTENIDO</th>
							<th>DEL</th>
						</TR>
					</thead>
					<tbody>
						@for(lista <- listaTransac){
							<TR>
								<td hidden="true">@lista.id_qrAtributoEquipo</td>
								<td hidden="true">@lista.id_qrTipoContenido</td>
								<td width="5%">
									<input type="text" class="form-control center"
										id="orden"
										value="@lista.orden"
										onkeydown="return ingresoInt(window.event)"
										onchange="if(value.trim().length==0) value=0; actualizaPorCampo('@lista.id_qrAtributoEquipo', id, value)">
								</td>
								<td width="20%" style="text-align:left;"><b>@lista.campo</b></td>
								<td width="70%" style="text-align:left;">
						        	@if(lista.id_qrTipoContenido==1){
						        		@if(!lista.contenido.equals("0")){
											<textarea class="form-control" style="text-align:left;" rows="1"
												id="contenido"
												onfocus="$('#auxiliarDeCambio').val(value)"
												onchange="actualizaPorCampo('@lista.id_qrAtributoEquipo', id, value)" 
		  										autocomplete="off">@lista.contenido</textarea>
					        			}else{
											<textarea class="form-control" style="text-align:left;" rows="1"
												id="contenido"
												onchange="actualizaPorCampo('@lista.id_qrAtributoEquipo', id, value)" 
		  										autocomplete="off"></textarea>
					        			}
						        	}else{
						        		@if(lista.contenido.equals("0")){
						        			<span class="btn btn-warning btn-sm btn-file">Adjuntar @lista.tipo
												<input type="file"
						        					id="anexo@lista.id_qrAtributoEquipo" 
													onfocus="$('#auxiliarDeCambio').val(value)"
						        					onchange="grabarArchivo(this, id, '@lista.extencion', '@lista.id_qrAtributoEquipo','@lista.tipo')">
						        			</span>
						        		}else{
						        			<span class="btn btn-warning btn-sm btn-file">Cambiar @lista.tipo
												<input type="file"
						        					id="anexo@lista.id_qrAtributoEquipo" 
													onfocus="$('#auxiliarDeCambio').val(value)"
						        					onchange="grabarArchivo(this, id, '@lista.extencion', '@lista.id_qrAtributoEquipo','@lista.tipo')">
						        			</span>&nbsp;&nbsp;&nbsp;&nbsp;
						        			<button class='btn btn-info btn-sm' onclick="verArchivo('@lista.contenido','@lista.extencion')" >
												Revisar @lista.tipo Adjunto
											</button>
						        		}
						        	}
					        	</td>
								<td width="5%" style="text-align:center;">
									<a href="#" onclick= "eliminar(this, '@lista.id_qrAtributoEquipo')">
										<kbd style="background-color: red">X</kbd>
									</a>
								</td>
							</TR>
						}
						<TR>
							<td hidden="true"></td>
							<td hidden="true"></td>
							<td width="5%"></td>
					        <td width="30%" style="text-align:left;">
								<select class="custom-select" 
									onchange="agregarCampo(value)">
									<option value=""></option>
									@for(lista <- listaCamposFiltrado){
										<option value="@lista.id">@lista.nombre</option>
									}
								</select>
					        </td>
					        <td width="60%" style="text-align:left;"></td>
					        <td width="5%"></td>
						</TR>
					</tbody>
				</table>
				<div class="noprint">
					<div class="row justify-content-md-center" >
						<div class="col-xs-5 col-sm-2 col-md-2 col-lg-2">
							<input type="button" value="LISTO" class="btn btn-success btn-sm rounded-pill btn-block" onclick="location.href = '/qrListaEquipos/';">
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	

		<div id="muestraPDF" class="modal" role="dialog" data-backdrop="static" data-keyboard="false" aria-hidden="true" style="display: none;">
			<div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
				<div class="modal-content">
					<div class="modal-header">
					        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
					          <span aria-hidden="true">×</span>
					        </button>
					</div>
					<div class="modal-body">
						<div class='embed-responsive' style='padding-bottom:150%'>
							<div id="rutaPDF"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	
}




<script type="text/javascript">
	$(document).ready(function() {
		  document.getElementById('mostrarmostrar').style.display="block";
	});

	const agregarCampo = (idCampo) => {
		  	var tabla = document.getElementById('tablaCampos');
		  	var cellsOfRow = tabla.rows[tabla.rows.length-1].getElementsByTagName('td');
		  	//llena la linea de la tabla
		  	var idTipo="";
		  	var nombre="";
		  	@for(lista <- listaCampos){
        		if(@lista.id==idCampo){
        			cellsOfRow[0].innerHTML="@lista.id";
        			cellsOfRow[1].innerHTML="@lista.id_qrTipoContenido";
        			cellsOfRow[2].innerHTML="";
        			cellsOfRow[3].innerHTML="<b>@lista.nombre</b>";
        			cellsOfRow[4].setAttribute("style","text-align:left;");
        			if(@lista.id_qrTipoContenido==1){
        				cellsOfRow[4].innerHTML=
								"<textarea class='form-control' style='text-align:left;' rows='1' "+
										" id='contenido' "+
										" onfocus=\"$('#auxiliarDeCambio').val(value)\" "+
										" onchange='actualizaPorCampo("+idCampo+",id,value)' "+
										" autocomplete='off'></textarea>";
        			}else{
        				
        				cellsOfRow[4].innerHTML=
								"<span class='btn btn-warning btn-sm btn-file'>Adjuntar @lista.tipoContenido "+
										" <input type='file' "+
						        				" id='anexo@lista.id' "+
												" value='0' "+
												" onfocus=\"$('#auxiliarDeCambio').val(value)\" "+
						        				" onchange='grabarArchivo(this,id,\"@lista.extencion\",@lista.id,\"@lista.tipoContenido\")'> "+
						        "</span>";
        			}
					cellsOfRow[5].setAttribute("style","text-align:center;");
        			cellsOfRow[5].innerHTML=
									"<a href='#' onclick='eliminar(this,"+idCampo+")'>"+
										"<kbd style='background-color: red'>X</kbd>"+
									"</a>";
        		}
			}
		  	//grabo el campo en la base
		  	var formData = new FormData();
		  	formData.append('idEquipo','@qrEquipo.id_equipo');
		  	formData.append('idCampo',idCampo);
            $.ajax({
                url: "/qrAgregaCampoEquipo/",
                type: "POST",
                method: "POST",
                data: formData,
                cache: false,
                contentType: false,
		     	processData: false,
		     	success: function(respuesta){
		     		if(respuesta.status){
		     			cellsOfRow[2].innerHTML=
								"<input type='text' class='form-control center' "+
										" id='orden' "+
										" value='"+respuesta.orden+"' "+
										" onkeydown='return ingresoInt(window.event)' "+
										" onchange='if(value.trim().length==0) value=0;actualizaPorCampo("+idCampo+",id,value)'>";
		     			agregarLinea();
		     		}else{
		     			tabla.deleteRow(tabla.rows.length-1);
		     			alert("se presento un problema");
		     			agregarLinea();
		     		}
		     	}
	        }); 
            
	}
	

	const agregarLinea = () => {
		var tabla = document.getElementById('tablaCampos');
	  	//agrega nueva linea a la tabla
		var newRow = tabla.insertRow(tabla.rows.length);
	  	for(var i=0;i<6;i++){
	  		newRow.insertCell(i);
	  	}
		let flag=0;
		var selectCampo=
			"<select class='custom-select' "+
				"onchange='agregarCampo(value)'>"+
				"<option value=''></option>";
        	@for(lista <- listaCampos){
        		//reconoce campos ya agregados
        		flag=0;
        		for(var i=2;i<tabla.rows.length-1;i++){
			  		var auxCellOfRow = tabla.rows[i].getElementsByTagName('td');
			  		if(auxCellOfRow[0].innerHTML==@lista.id){
			  			flag = 1;
			  			break;
			  		}
			  	}
        		if(flag==0){
        			selectCampo = selectCampo + "<option value='@lista.id'>@lista.nombre</option>";
        		}
			}
        selectCampo = selectCampo + "</select>";
        var cellsOfRow = tabla.rows[tabla.rows.length-1].getElementsByTagName('td');
        cellsOfRow[0].setAttribute("width","5%");
        cellsOfRow[0].setAttribute("hidden","true");
        cellsOfRow[1].setAttribute("width","5%");
        cellsOfRow[1].setAttribute("hidden","true");
        cellsOfRow[2].setAttribute("width","5%");
        cellsOfRow[3].setAttribute("width","30%");
        cellsOfRow[3].setAttribute("style","text-align:left;");
        cellsOfRow[4].setAttribute("width","60%");
        cellsOfRow[5].setAttribute("width","5%");
        cellsOfRow[3].innerHTML=selectCampo;
	}
	
	const actualizaPorCampo = (idCampo,campoMySql,valor) => {
    	  var formData = new FormData();
		  	formData.append('idEquipo','@qrEquipo.id_equipo');
		  	formData.append('idCampo',idCampo);
		  	formData.append('campoMySql',campoMySql);
		  	formData.append('valor',valor);
            $.ajax({
                url: "/qrActualizaPorCampo/",
                type: "POST",
                method: "POST",
                data: formData,
                cache: false,
                contentType: false,
		     	processData: false,
		     	success: function(respuesta){
		     		if(!respuesta.status){
		     			alert("se presento un problema");
		     		}
		     	}
	        }); 
     }

	const eliminar = (nodo,idCampo) => {
		alertify.confirm("Esta seguro de eliminar ", function (e) {
			if (e) {
				var formData = new FormData();
				formData.append('idEquipo','@qrEquipo.id_equipo');
			  	formData.append('idCampo',idCampo);
		        $.ajax({
		            url: "/qrEliminaCampoEquipo/",
		            type: "POST",
		            method: "POST",
		            data: formData,
		            cache: false,
		            contentType: false,
			     	processData: false,
			     	success: function(respuesta){
			     		if(!respuesta.status){
			     			alert("se presento un problema");
			     		}
			     	}
		        }); 
		        nodo.parentNode.parentNode.remove();
			}
		});
	}
	
	const grabarArchivo = (nodo,id,extencion,idCampo,tipo) => {
		var file = $("#"+id)[0].files[0];
		var fileName = file.name;
		var fileExtencion = fileName.substring(fileName.lastIndexOf('.') + 1);
		if(extencion.trim().toUpperCase() == fileExtencion.trim().toUpperCase()){
			var formData = new FormData();
            formData.append('anexo',file);
            formData.append('extencion',fileExtencion);
            formData.append('idEquipo','@qrEquipo.id_equipo');
		  	formData.append('idCampo',idCampo);
            $.ajax({
                url: "/qrGrabaAnexoEquipo/",
                type: "POST",
                method: "POST",
                data: formData,
                cache: false,
                contentType: false,
		     	processData: false,
		     	success: function(respuesta){
		     		if(respuesta.status){
		     			nodo.parentNode.parentNode.innerHTML=
							"<span class='btn btn-warning btn-sm btn-file'>Cambiar "+tipo+
									"<input type='file' "+
						        			" id='"+id+"' "+ 
											" onfocus=\"$('#auxiliarDeCambio').val(value)\" "+
											" onchange='grabarArchivo(this,id,\""+extencion+"\","+idCampo+",\""+tipo+"\")'>"+
							"</span>&nbsp;&nbsp;&nbsp;&nbsp;"+
						    "<button class='btn btn-info btn-sm' onclick='verArchivo(\""+respuesta.archivo+"\",\""+extencion+"\")'>"+
								"Revisar "+tipo+" Adjunto</button>";
	        			actualizaPorCampo(idCampo,'contenido',respuesta.archivo);
		     		}else{
		     			alert("se presento un problema");
		     		}
		     	}
	        }); 
		}else{
			alert("Se permiten únicamente archivos con la extención: ." 
					+ extencion + "\nPor favor, seleccione otro archivo "
					+ "e intente de nuevo.");
		}
	}


	const verArchivo = (archivo,extencion) => {
		document.getElementById('rutaPDF').innerHTML="<object data='/showPdf/"+archivo+"' type='application/pdf' width='100%' height='720'></object>";
		$('#muestraPDF').modal('show');
	}



</script>


		
		
	
