@(mapDiccionario: Map[String,String], mapPermiso: Map[String,String], userMnu: utilities.UserMnu,
allPlan: List[tables.PlanMantencion], listAtributos: List[String], listCompra: List[String])



    	
@main("") {

@menues(mapDiccionario, mapPermiso, userMnu, " ")
	<div id="mostrarmostrar" style="display:none;">
		@barraTitulo(mapDiccionario, "PROGRAMA PLAN DE MANTENCION","MODIFICAR")
		<div class="row  justify-content-md-center">
			<div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
				<table id="tablaPrincipal" class="table table-sm table-hover table-bordered table-condensed table-fluid">
					<tr>
						<td colspan="2">
							<b>DETALLE DEL EQUIPO</b>
						</td>
						<td colspan="6">
							<b>ULTIMA COMPRA</b>
						</td>
						
					</tr>
					<tr>
						<td>GRUPO:</td>
						<td>@allPlan.get(0).equipoGrupo</td>
						<td>@mapDiccionario.get("RUT")-PROV:</td>
						<td>@listCompra.get(0)</td>
						<td>FECHA:</td>
						<td>@listCompra.get(3)</td>
						<td>MONEDA:</td>
						<td>@listCompra.get(5)</td>
					</tr>
					<tr>
						<td>CODIGO EQUIPO:</td>
						<td>@allPlan.get(0).equipoCodigo</td>
						<td>PROVEEDOR:</td>
						<td>@listCompra.get(1)</td>
						<td>PDF:</td>
						<td>
							@if(listCompra.get(4)!="0"){
								<a href="#" onclick="mostrarPDF('@listCompra.get(4)')">
									<kbd style="background-color: #85C1E9">pdf</kbd>
								</a>
							}else{
							---
							}
						</td>
						<td>PRECIO:</td>
						<td>@listCompra.get(6)</td>
					</tr>
					<tr>
						<td>NOMBRE EQUIPO:</td>
						<td>@allPlan.get(0).equipoNombre</td>
						<td>FACTURA:</td>
						<td>@listCompra.get(2)</td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td colspan="20">
							<b>ATRIBUTOS DEL EQUIPO</b>
						</td>
					</tr>
					<tr>
						<td colspan="20">
							@for(lista <- listAtributos){
									@lista|
								}
						</td>
					</tr>
				</table>
				<table id="planes" class="table table-sm table-hover table-bordered table-condensed table-fluid">
					<tr>
						<td colspan="20">
							<h5><b><font color="#008000"> PLAN DE MANTENCION</font></b></h5>
						</td>
					</tr>
					<tr>
						<TH style="text-align:center">Plan</TH>
						<TH style="text-align:center">Fecha<br>Lectura</TH>
						<TH style="text-align:center">Unidad</TH>
						<TH style="text-align:center">Cantidad<br>Lectura</TH>
						<TH style="text-align:center">Rotación (Cada X Cantidad<br>Correspone Mantención)</TH>
						<TH style="text-align:center">Consumo Promedio<br>Mensual Estimado</TH>
						<TH style="text-align:center">Corresponde Próxima<br>Mantención a los</TH>
						<TH style="text-align:center">Fecha Estimada<br>Mantencion</TH>
					</tr>
					@for((lista, index) <- allPlan.zipWithIndex) {
						<tr>
							<td style="text-align:center">
								<input type="hidden" class="id_tipoPlan" value="@lista.id_tipoPlan">
								@lista.tipoPlanNombre
							</td>
							
							<td style="text-align:center">
								<input type="date" class="fechaReset form-control center"
						  			onblur="if(!limitaFecha(value,720,10)) {
												value = '@utilities.Fechas.AAMMDD(lista.fechaReset)';
											} else {
												actualizaAll('@lista.id_unidadMantencion', '@lista.id_equipo', 'fechaReset', value);
											}"
						  			value="@utilities.Fechas.AAMMDD(lista.fechaReset)">
							</td>
							
							<td style="text-align:center">
								<input type="hidden" class="id_unidadMantencion" value="@lista.id_unidadMantencion">
								@lista.unidadMantencion @mapPermiso.get("parametro.planes_calculaProximaMant")
							</td>
							<!-- Estado Actual -->
							<td style="text-align:right">
								<input type="text" class="estadoActual form-control center"
									id="lectActual_@index"
									value="@lista.estadoActual"
									onfocus="value = value.replace(/,/g,''); auxiliar = value;" 
									onkeypress="return ingresoDouble(event,value)"
									autocomplete="off"
									onchange="if(value=='') value=0;
										actualizaAll('@index', '@lista.id_equipo', 'estadoActual', value);">
							</td> 
							
							<td style="text-align:center">
							    <input type="hidden" class="cadaNEstimado" value="@lista.cadaNEstimado">
							    @lista.cadaNEstimado
							</td>
							<td style="text-align:center">
							    <input type="hidden" class="consumoEstimadoPorMes" value="@lista.consumoEstimadoPorMes">
							    @lista.consumoEstimadoPorMes
							</td>
							
							@if(mapPermiso.get("parametro.planes_calculaProximaMant") != null && mapPermiso.get("parametro.planes_calculaProximaMant").equals("0")) {
							    <!-- Modo edición manual -->
							    <td style="text-align:right">
							        <input type="text" class="proximaMantencion form-control center"
							               id="proximaMantencion_@index"
							               value="@lista.proximaMantencion"
							               onfocus="value = value.replace(/,/g,'');"
							               onkeypress="return ingresoDouble(event, value)"
							               autocomplete="off"
							               onchange="if(value == '') value = 0; recalcularFechaEstimada('@index', '@lista.id_tipoPlan', '@lista.id_equipo');">
							    </td>
							} else {
							    <!-- Modo cálculo automático -->
							    <td style="text-align:right">
							        <input type="text" class="proximaMantencion form-control center"
							               id="proximaMantencion_@index"
							               value="@lista.proximaMantencion"
							               disabled>
							    </td>
							}

							<td style="text-align:center">
								<input type="date" class="fechaEstimada form-control center" disabled>
							</td>
						</tr>
					}
				</table>
			</div>
		</div>	
		<div class="noprint">
			<div class="row justify-content-md-center" >
				<div class="col-xs-5 col-sm-2 col-md-2 col-lg-2">
					<input type="button"  value="VOLVER" class="btn btn-success btn-sm rounded-pill btn-block" onclick="location.href='/hojaVidaMantencionLista/0';">
				</div>
				<div class="col-xs-5 col-sm-2 col-md-2 col-lg-2">
					<input type="button"  value="CANCELAR" class="btn btn-light btn-sm rounded-pill btn-block" onclick="location.href='/home/';">
				</div>
			</div>
		</div>
	</div>
	
	<div id='muestraPDF' class='modal' role='dialog' data-backdrop='static' data-keyboard='false'>
		<div class='modal-dialog modal-dialog-scrollable modal-lg' role='document'>
			<div class='modal-content'>
				<div class='modal-header'>
					<h5 class='modal-title'>COMPRA</h5>
				        <button type='button' class='close' data-dismiss='modal' aria-label='Close'>
				          <span aria-hidden='true'>&times;</span>
				        </button>
				</div>
				<div class='modal-body'>
					<div id="rutaPDF"></div>
	   				<div class='row'>
						<div class='col-sm-12' style='text-align:center'>
							<button type='button' class='btn btn-sm  btn-success' style='font-size: 10px;' data-dismiss='modal'>Listo</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
}




<script type="text/javascript">
	$(document).ready(function() {
		calcFechaProxima();
		document.getElementById('mostrarmostrar').style.display="block";
	});
	
	const calcFechaProxima = () => {
	    let filas = $(".estadoActual").length;
	    let hoy = new Date();
	
	    for (let i = 0; i < filas; i++) {
	        let fecha = $(".fechaReset")[i].value; // Fecha de referencia
	        let proxima = parseFloat($(".proximaMantencion")[i].value.replace(/,/g, '') || 0);
	        let actual = parseFloat($(".estadoActual")[i].value.replace(/,/g, '') || 0);
	        let rotacion = parseFloat($(".consumoEstimadoPorMes")[i].value.replace(/,/g, '') || 0);
	
	        let dif = proxima - actual;
	
	        if (dif <= 0 || rotacion <= 0) {
	            $(".fechaEstimada")[i].value = fechaAAMMDD(hoy);
	        } else {
	            let diasASumar = (dif / rotacion) * 30;
	
	            let auxFecha;
	            try {
	                let aux = fecha.split("-");
	                auxFecha = new Date(aux[0], parseInt(aux[1]) - 1, aux[2]);
	                auxFecha.setDate(auxFecha.getDate() + diasASumar);
	            } catch (error) {
	                auxFecha = hoy;
	            }
	
	            $(".fechaEstimada")[i].value = fechaAAMMDD(auxFecha);
	        }
	    }
	}

	
	const mostrarPDF = (nombrePDF) => {
		  document.getElementById('rutaPDF').innerHTML="<object data='/showPdf/"+nombrePDF+"' type='application/pdf' width='100%' height='720'></object>";
		  $('#muestraPDF').modal('show');
	}
	
	const actualizaPorCampo = (id_tipoPlan, id_equipo, campo, valor) =>{
		var formData = new FormData();
	  	formData.append('id_tipoPlan',id_tipoPlan);
		formData.append('id_equipo',id_equipo);
		formData.append('campo',campo);
	  	formData.append('valor',valor);
        $.ajax({
            url: "/actualCampoPlanMantencionAjax/",
            type: "POST",
            method: "POST",
            data: formData,
            cache: false,
            contentType: false,
	     	processData: false,
	     	success: function(respuesta){
				calcFechaProxima();
	     	}
        });
	}

	const actualizaAll = (index, id_equipo, campo, valor) => {
	    const unidadCambiada = $(".id_unidadMantencion")[index].value;
	    const filas = $(".estadoActual").length;
	
	    for (let i = 0; i < filas; i++) {
	        if ($(".id_unidadMantencion")[i].value === unidadCambiada) { 
	            if (campo === 'estadoActual') { 
	                $(".estadoActual")[i].value = valor; 
	                actualizaPorCampo($(".id_tipoPlan")[i].value, id_equipo, campo, valor); 
	                actualizarProximaMantencion(i, $(".id_tipoPlan")[i].value, id_equipo, campo); 
	            }
	        }
	    }
	};



	let calculoAutomatico = "1";
	@if(mapPermiso.get("parametro.planes_calculaProximaMant") != null && mapPermiso.get("parametro.planes_calculaProximaMant").equals("0")) {
		calculoAutomatico = "0";
	}

	function determinaProxima(lectActual, frecuencia) {
		if(calculoAutomatico == 1){
			if (frecuencia <= 0) {
				alert("la rotacion debe ser mayor a 0")
				return 0;
			}
			if (lectActual % frecuencia === 0) {
				// Caso múltiplo exacto
				return lectActual + frecuencia;
			} else {
				// Redondear al siguiente múltiplo
				const resto = lectActual % frecuencia;
				return lectActual - resto + frecuencia;
			}
		}else{
			if (frecuencia < 0){
				alert("la rotacion debe ser mayor a 0");
			}else {
				return lectActual + frecuencia;
			}
		}

	}

	function validaHoras(frecuencia, siguienteMantencion, mantencionAnterior, origen) {
		if (!frecuencia || !siguienteMantencion) {
			return false;
		}
		if(calculoAutomatico == 1){
			const isValid = siguienteMantencion % frecuencia === 0;
			return isValid;
		}else{
			return true;
		}

	}

	let auxiliar = 0;

	function actualizarProximaMantencion(index, id_tipoPlan, id_equipo, origen) {
	    const lectActual = parseFloat($("#lectActual_" + index).val()?.replace(/,/g, "") || 0);
	    const frecuencia = parseFloat($(".cadaNEstimado")[index]?.value?.replace(/,/g, "") || 0);
	
	
	    if (frecuencia > 0) {
			@if(mapDiccionario.get("nEmpresa").equals("CIHLA")){
				return("no aplica");
			}
	        const proximaMantencion = determinaProxima(lectActual, frecuencia);
	        let mantencionAnterior = parseFloat($("#proximaMantencion_" + index).val()?.replace(/,/g, "") || 0);
	
	        const isValid = validaHoras(frecuencia, proximaMantencion, mantencionAnterior, origen);
	
	        if (isValid) {
	            $("#proximaMantencion_" + index).val(proximaMantencion);
	            actualizaPorCampo(id_tipoPlan, id_equipo, 'proximaMantencion', proximaMantencion);
				calcFechaProxima(index);
	
	        } else {
	            alert("El valor a ingresar debe ser mayor que cero.");
	        }
	    }
	}
	
// FUNCION PARA RECALCULAR FECHA CUANDO horometro.planes_calculaProximaMant ES 0, ES DECIR LA PROXIMA MATENCION ES MANIPULABLE DE FORMA MANUAL


	function recalcularFechaEstimada(index, id_tipoPlan, id_equipo) {
	    // Leer los valores de la fila correspondiente
	    const proximaMantencion = parseFloat($("#proximaMantencion_" + index).val()?.replace(/,/g, "") || 0);
	    const fechaReset = $(".fechaReset")[index].value;
	    const consumoPromedio = parseFloat($(".consumoEstimadoPorMes")[index].value?.replace(/,/g, "") || 0);

	    // Validar valores
	    if (proximaMantencion <= 0 || consumoPromedio <= 0) {
	        alert("El valor ingresado no es válido.");
	        return;
	    }
	
	    // Calcular nueva fecha estimada
	    let diasASumar = (proximaMantencion / consumoPromedio) * 30;
	    let nuevaFecha;
	
	    try {
	        let aux = fechaReset.split("-");
	        nuevaFecha = new Date(aux[0], parseInt(aux[1]) - 1, aux[2]);
	        nuevaFecha.setDate(nuevaFecha.getDate() + diasASumar);
	    } catch (error) {
	        nuevaFecha = new Date(); // Fecha actual si hay errores
	    }
	
	    // Actualizar la fecha estimada en la interfaz
	    $(".fechaEstimada")[index].value = fechaAAMMDD(nuevaFecha);
	
	    // Guardar el cambio en la base de datos
	    actualizaPorCampo(id_tipoPlan, id_equipo, "proximaMantencion", proximaMantencion);
	}




</script>
	
