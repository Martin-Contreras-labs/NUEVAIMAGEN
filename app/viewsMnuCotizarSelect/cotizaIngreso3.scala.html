@(mapDiccionario: Map[String,String], mapPermiso: Map[String,String], userMnu: utilities.UserMnu,
formCotiza: forms.FormCotiza, listClientes: List[tables.Cliente], listProyectos: List[tables.Proyecto], detalle: List[List[String]], 
numDecParaTot: String,listRegiones: List[tables.Regiones],
listUnTiempo: List[tables.UnidadTiempo], 
sucursal: tables.Sucursal, comercial: tables.Comercial, listSucursal: List[tables.Sucursal], listComercial: List[tables.Comercial],
importDesdeExcel: String, json: String)

@main("") {

@menues(mapDiccionario, mapPermiso, userMnu, " ")
<div id="bloquear2" class="blocker" style="display:none;"><br><br><br><br><br><br><h1>Se esta actualizando... </h1></div>
	@modalEquipoDescripcion()

	<!-- MODAL CREA CLIENTES -->
		@modalClienteNuevo(mapDiccionario, listRegiones)
		<script>
			const clienteGrabaAjax = (id_cliente) =>{
				$('#id_cliente').val(id_cliente);
				$('#rutCliente').val($("#clienteRut").val());
				$('#nombreCliente').val($("#clienteNickName").val());
				let tabla = document.getElementById('tablaListaClientes');
				let row = tabla.insertRow(tabla.rows.length);
				let cell = row.insertCell(0);
				cell.style.textAlign = "left";
				cell.innerHTML = $("#clienteRut").val();
				cell = row.insertCell(1);
				cell.style.textAlign = "left";
				cell.innerHTML = $("#clienteNickName").val();
				cell = row.insertCell(2);
				cell.style.textAlign = "left";
				cell.innerHTML = $("#clienteNombre").val();
				row.setAttribute("onClick", "$('#id_cliente').val('" + id_cliente + "'); $('#rutCliente').val('" + $("#clienteRut").val() + "');$('#nombreCliente').val('" + $("#clienteNickName").val() + "');");
				row.setAttribute("data-dismiss", "modal");
			}
		</script>
	<!-- FIN MODAL CREA CLIENTES -->
	
	<!-- MODAL CREA PROYECTOS -->
		@modalProyectoNuevo(mapDiccionario, listRegiones)
		<script>
			const proyectoGrabaAjax = (id_proyecto) =>{
				$('#id_proyecto').val(id_proyecto);
				$('#nombreProyecto').val($("#proyectoNickName").val());
				let tabla = document.getElementById('tablaListaProyectos');
				let row = tabla.insertRow(tabla.rows.length);
				let cell = row.insertCell(0);
				cell.style.textAlign = "left";
				cell.innerHTML = $("#proyectoNickName").val();
				cell = row.insertCell(1);
				cell.style.textAlign = "left";
				cell.innerHTML = $("#proyectoNombre").val();
				cell = row.insertCell(2);
				cell.style.textAlign = "left";
				cell.innerHTML = "";
				row.setAttribute("onClick", "$('#id_proyecto').val('" + id_proyecto + "'); $('#nombreProyecto').val('" + $("#proyectoNickName").val() + "');");
				row.setAttribute("data-dismiss", "modal");
			}
		</script>
	<!-- FIN MODAL CREA PROYECTOS -->
	

	<form action="/cotizarNuevo/" enctype="multipart/form-data" method="POST" onsubmit="return validarForm();">
		<div id="mostrarmostrar" style="display:none;">
			@barraTitulo(mapDiccionario, "INGRESO DE NUEVA COTIZACION", "")
			<div class="row  justify-content-md-center">
				<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
					<table class="table table-sm table-hover table-bordered table-condensed table-fluid">
						<thead style="background-color: #eeeeee">
							<tr>
								<td width="230px">
									<input type="hidden" id="id_cotizacion" name="id_cotizacion" value="@formCotiza.id_cotizacion">
									<div class="input-group">
								  		<div class="input-group-prepend">
								    		<span class="input-group-text" id="basic-addon1">Nro.Cotizacion</span>
								  		</div>
								  		<input type="text" class="form-control left"
								  				id="numeroCoti"
												name="numeroCoti"
												value = "@formCotiza.numeroCoti"
												onkeypress="return ingresoInt(event,value)"
												onchange="if(value.trim()==''){value='@formCotiza.numeroCoti';}else{validarNumero(value);}">
									</div>
								</td>
								<td width="230px">
									<div class="input-group">
								  		<div class="input-group-prepend">
								    		<span class="input-group-text" id="basic-addon1">Fecha</span>
								  		</div>
								  		<input type="date" class="form-control center"
								  			name="fechaCoti" 
								  			id="fechaCoti"
								  			onblur="if(!limitaFecha(value,720,10)) value='@formCotiza.fechaCoti';"
								  			value="@formCotiza.fechaCoti"
						        			required>
									</div>
								</td>
								<td width="230px">
									<div class="input-group">
								  		<div class="input-group-prepend">
								    		<span class="input-group-text" id="basic-addon1">@mapDiccionario.get("RUT") Cliente</span>
								  		</div>
								  		<input type="hidden" id="id_cliente" name="id_cliente" value="@formCotiza.id_cliente">
										@if(mapPermiso.get("parametro.cotizaPorTasa").equals("1")) {
											@if(formCotiza.id_cliente>0){
												<input type="text" class="form-control"
			  										id="rutCliente"
			  										value="@formCotiza.rutCliente"
			  										readonly>
											}else{
												<input type="text" class="form-control"
			  										id="rutCliente"
			  										value="@formCotiza.rutCliente" 
			  										style="background:white"
			  										onclick="$('#listaCliente').modal('show');"
			  										readonly>
											}
										}else{
											<input type="text" class="form-control"
		  										id="rutCliente"
		  										value="@formCotiza.rutCliente" 
		  										style="background:white"
		  										onclick="$('#listaCliente').modal('show');"
		  										readonly>
										}
									</div>
								</td>
								<td>
									<div class="input-group">
								  		<div class="input-group-prepend">
								    		<span class="input-group-text" id="basic-addon1">Cliente</span>
								  		</div>
											@if(mapPermiso.get("parametro.cotizaPorTasa").equals("1")) {
												@if(formCotiza.id_cliente>0){
													<input type="text" class="form-control left"
													id="nombreCliente"
													value="@formCotiza.nickCliente"
													required
													readonly>
												}else{
													<input type="text" class="form-control left"
													id="nombreCliente"
													value="@formCotiza.nickCliente"
													style="background:white"
													onclick='$("#listaCliente").modal("show")'
													required
													readonly>
												}
											}else{
												<input type="text" class="form-control left"
													id="nombreCliente"
													value="@formCotiza.nickCliente"
													style="background:white"
													onclick='$("#listaCliente").modal("show")'
													required
													readonly>
											}
									</div>
								</td>
								<td>
									<div class="input-group">
								  		<div class="input-group-prepend">
								    		<span class="input-group-text" id="basic-addon1">Proyecto</span>
								  		</div>
										<input type="hidden" id="id_proyecto" name="id_proyecto" value="@formCotiza.id_proyecto">
										@if(mapPermiso.get("parametro.cotizaPorTasa").equals("1")) {
											<input type="text" class="form-control left"
												id="nombreProyecto"
												value="@formCotiza.nickProyecto"
												readonly>
										}else{
											<input type="text" class="form-control left"
												id="nombreProyecto"
												value="@formCotiza.nickProyecto"
												style="background:white"
												onclick='$("#listaProyecto").modal("show")'
												readonly>
										}
									</div>
								</td>
								<td>
									<span class="btn btn-info btn-sm btn-file" style="font-size: 8px;">
										<div id="txtBtn">Adjuntar</div>
				    					<input type="file" id="docAdjunto" name="docAdjunto" onchange="LimitAttach(this.form, this.form.docAdjunto.value);">
									</span>
								</td>
							</tr>
							<tr>
							
							
								
								<td align="center"  colspan="2">
									<input type="hidden" id="id_sucursal" name="id_sucursal" value="@sucursal.getId()">
									<div class="input-group">
								  		<div class="input-group-prepend">
								    		<span class="input-group-text" id="basic-addon1">Sucursal</span>
								  		</div>
										@if(mapPermiso.get("cambiarSucursal")!=null){
											@if(mapPermiso.get("cambiarComercial")!=null){
												<select id="selSucursal" class="custom-select"  style="width: 80px;" onchange = "$('#id_sucursal').val(value); actualizaComerciales(value); actualizaPrecios(value);">
													<option value="@sucursal.getId()">@sucursal.getNombre()</option>
													@for(lista <- listSucursal){
														<option value="@lista.getId()">@lista.getNombre()</option>
													}
												</select>
											}else{
												<select id="selSucursal" class="custom-select"  style="width: 80px;" onchange = "$('#id_sucursal').val(value); actualizaPrecios(value);">
													<option value="@sucursal.getId()">@sucursal.getNombre()</option>
													@for(lista <- listSucursal){
														<option value="@lista.getId()">@lista.getNombre()</option>
													}
												</select>
											}
										}else{
											<input  id="selSucursal" type="text" class="form-control left"
												value = "@sucursal.getNombre()"
												readonly>
										}
									</div>
								</td>
								
								
								
								<td colspan="20" rowspan="3">
									<div class="input-group">
								  		<div class="input-group-prepend">
								    		<span class="input-group-text" id="basic-addon1">Observaciones</span>
								  		</div>
	  									<textarea class="form-control" rows="3"
	  										name="observaciones" 
	  										autocomplete="off">@formCotiza.observaciones</textarea>
									</div>
								</td>
							</tr>
							<tr>
							
							
								<td align="center"  colspan="2">
									<div id="actualComerciales">
										<input type="hidden" id="id_comercial" name="id_comercial" value="@comercial.getId()">
										<div class="input-group">
									  		<div class="input-group-prepend">
									    		<span class="input-group-text" id="basic-addon1">Comercial</span>
									  		</div>
											@if(mapPermiso.get("cambiarComercial")!=null){
												<select  id="selComercial" class="custom-select"  style="width: 80px;" onchange="$('#id_comercial').val(value)">
													<option value="@comercial.getId()">@comercial.getNameUsuario()</option>
													@for(lista <- listComercial){
														<option value="@lista.getId()">@lista.getNameUsuario()</option>
													}
												</select>
											}else{
												<input  id="selComercial" type="text" class="form-control left"
													value = "@comercial.getNameUsuario()"
													readonly>
											}
										</div>
									</div>
								</td>
									
									
									
							</tr>
							<tr>
								<input type="hidden" id="id_bodegaEmpresa" name="id_bodegaEmpresa" value="@formCotiza.id_bodegaEmpresa">
								@if(mapPermiso.get("parametro.cotizaPorTasa").equals("1")) {
									<td align="center"  colspan="2">
										<div class="input-group">
									  		<div class="input-group-prepend">
									    		<span class="input-group-text" id="basic-addon1">@mapDiccionario.get("BODEGA")/PROYECTO</span>
									  		</div>
									  		<input type="text" class="form-control left"
													value = "@formCotiza.nombreBodega"
													readonly>
										</div>
									</td>
								}
							</tr>
						</thead>
					</table>
					<hr>
					
					<div class="noprint" align="center">
						<div class="row justify-content-md-center" >
							<div class="col-xs-5 col-sm-2 col-md-2 col-lg-2">
								<input id="btnCopiaCoti" type="button"  value="Copiar desde otra cotización" class="btn btn-warning btn-sm rounded-pill btn-block" 
									onclick="listadoCotizaciones()">&nbsp;&nbsp;&nbsp;
							</div>
							<div class="col-xs-5 col-sm-2 col-md-2 col-lg-2">
								<input id="btnCargaExcel" type="button"  value="Copiar desde un Excel" class="btn btn-info btn-sm rounded-pill btn-block" 
									onclick="$('#modalCargaMasiva').modal('show');">&nbsp;&nbsp;&nbsp;
							</div>
						</div>
					</div>
					
					
					<div id='modalTasaGlobal' class='modal' role='dialog' data-backdrop='static' data-keyboard='false'>
						<div class='modal-dialog modal-dialog-scrollable' role='document' style="width:300px">
							<div class='modal-content'>
								<div class='modal-header'>
								        <button type='button' class='close' data-dismiss='modal' aria-label='Close'>
								          <span aria-hidden='true'>&times;</span>
								        </button>
								</div>
								<div class='modal-body'>
									<div class="input-group">
								  		<div class="input-group-prepend">
								    		<span class="input-group-text" id="basic-addon1">APLICAR TASA GLOBAL</span>
								  		</div>
								  		<input type="text" class="form-control center"
											id="tasaGlobal"
											value="0.00 %"
											onfocus="value = value.replace(/,/g,'').replace(/%/g,'').replace(/ /g,'')"
											onkeypress="return ingresoDouble(event,value)"
											autocomplete="off"
											onchange="value = formatPorcentaje(value); if(value=='') {value='0.00 %';}">
									</div>
									<br>
									<div class='row'>
										<div class='col-sm-12' style='text-align:center'>
											<input type="button" class="btn btn-sm btn-primary" value='Aplicar' onclick='$("#modalTasaGlobal").modal("hide"); aplicarTasaGlobal();'>
											<input type='button' class='btn btn-sm btn-warning' value='Cancelar' data-dismiss='modal'>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					
					<div id='modalFactorGlobal' class='modal' role='dialog' data-backdrop='static' data-keyboard='false'>
						<div class='modal-dialog modal-dialog-scrollable' role='document' style="width:300px">
							<div class='modal-content'>
								<div class='modal-header'>
								        <button type='button' class='close' data-dismiss='modal' aria-label='Close'>
								          <span aria-hidden='true'>&times;</span>
								        </button>
								</div>
								<div class='modal-body'>
									<div class="input-group">
								  		<div class="input-group-prepend">
								    		<span class="input-group-text" id="basic-addon1">FACTOR SOBRE @mapDiccionario.get("ARRIENDO")</span>
								  		</div>
								  		<input type="text" class="form-control center"
											id="factorGlobal"
											value="0.0000"
											onfocus="value = value.replace(/,/g,'')"
											onkeypress="return ingresoDouble(event,value)"
											autocomplete="off"
											onchange="value = formatStandar(value,4); if(value=='') {value='0.0000';}">
									</div>
									<br>
									<div class='row'>
										<div class='col-sm-12' style='text-align:center'>
											<input type="button" class="btn btn-sm btn-primary" value='Aplicar' onclick='$("#modalFactorGlobal").modal("hide"); aplicarFactorGlobal();'>
											<input type='button' class='btn btn-sm btn-warning' value='Cancelar' data-dismiss='modal'>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					
					<div id='modalFactorGlobalRepos' class='modal' role='dialog' data-backdrop='static' data-keyboard='false'>
						<div class='modal-dialog modal-dialog-scrollable' role='document' style="width:300px">
							<div class='modal-content'>
								<div class='modal-header'>
								        <button type='button' class='close' data-dismiss='modal' aria-label='Close'>
								          <span aria-hidden='true'>&times;</span>
								        </button>
								</div>
								<div class='modal-body'>
									<div class="input-group">
								  		<div class="input-group-prepend">
								    		<span class="input-group-text" id="basic-addon1">FACTOR SOBRE VTA/REPOS</span>
								  		</div>
								  		<input type="text" class="form-control center"
											id="factorGlobalRepos"
											value="0.0000"
											onfocus="value = value.replace(/,/g,'')"
											onkeypress="return ingresoDouble(event,value)"
											autocomplete="off"
											onchange="value = formatStandar(value,4); if(value=='') {value='0.0000';}">
									</div>
									<br>
									<div class='row'>
										<div class='col-sm-12' style='text-align:center'>
											<input type="button" class="btn btn-sm btn-primary" value='Aplicar' onclick='$("#modalFactorGlobalRepos").modal("hide"); aplicarFactorGlobalRepos();'>
											<input type='button' class='btn btn-sm btn-warning' value='Cancelar' data-dismiss='modal'>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
	
					<table id="tablaPrincipal" class="table table-sm table-hover table-bordered table-condensed table-fluid">
						<thead style="background-color: #eeeeee">
							<TR>
								<TH colspan="8" style="background-color: white"></TH>
								<TH style="text-align:center">
									<input id="btnAplicarFactor" type="button"  value="Aplica Factor" class="btn btn-warning btn-sm rounded-pill btn-block" onclick='$("#modalFactorGlobalRepos").modal("show")'>
								</TH>
								<TH style="background-color: white"></TH>
								<TH style="text-align:center">
									<input id="btnAplicarTasa" type="button"  value="Aplica Tasa" class="btn btn-warning btn-sm rounded-pill btn-block" onclick='$("#modalTasaGlobal").modal("show")'>
								</TH>
								<TH style="text-align:center">
									<input id="btnAplicarFactor" type="button"  value="Aplica Factor" class="btn btn-warning btn-sm rounded-pill btn-block" onclick='$("#modalFactorGlobal").modal("show")'>
								</TH>
								<TH colspan="12" style="background-color: white"></TH>
							</TR>
							<TR>
								<TH>GRUPO</TH>
								<TH>CODIGO</TH>
								<TH style="min-width:30%">EQUIPO</TH>
								<TH>STOCK</TH>
								<TH>UN</TH>
								<TH>CANT</TH>
						        <TH>SOLO<br>VENTA</TH>
						        <TH>MON</TH>
								<TH>P.UNITARIO<br>VTA/REPOS</TH>
								<TH>UN<br>@mapDiccionario.get("ARR")</TH>
								<TH>TASA<br>@mapDiccionario.get("ARR")/VTA</TH>
								<TH>P.UNITARIO<br>@mapDiccionario.get("ARR")</TH>
								<TH>PERMAN</TH>
								<TH>P.TOTAL<br>REPOSICION</TH>
								<TH>P.TOTAL<br>@mapDiccionario.get("ARRIENDO")</TH>
								<TH>P.TOTAL<br>VENTA</TH>
								<TH>TOT.KG</TH>
								@if(mapPermiso.get("parametro.escondeLosM2")!=null && mapPermiso.get("parametro.escondeLosM2").equals("1")) {
									<TH style = "display:none">TOT.M2</TH>
								}else{
									<TH>TOT.M2</TH>
								}
								<TH style = "display:none">kg</TH>
								<TH style = "display:none">m2</TH>
								<TH style = "display:none">id_equipo</TH>
								<TH style = "display:none">nrodecimal</TH>
							</TR>
						</thead>
						<tbody>
							@for(lista1 <- detalle){
								<TR>
									<td style="text-align:left;">
											@lista1.get(23)
									</td>
									<td style="text-align:left;">
										<input class="idEquipo" type="hidden" name="id_equipo[]" value="@lista1.get(0)">
										<input type="hidden" name="id_moneda[]" value="@lista1.get(8)">
										
										<a href="#" onclick="equipoDescripcion('@lista1.get(0)');">
											@lista1.get(1)
										</a>
									</td>
									<td style= "text-align: left;"><a href="#" onclick="equipoDescripcion('@lista1.get(0)');">@lista1.get(2)</a></td>
									<td style="text-align:center;">
										<div class="noprint">
											<a href="#" onclick="vistaStockPorEquipo('@lista1.get(0)');">
												<kbd style="background-color: #73C6B6">stock</kbd>
											</a>
										</div>
									</td>
									<td style="text-align:center;">@lista1.get(3)</td>
									<td style="text-align:center;">
										<div style="display:none" id="hiddencantidad_@lista1.get(0)">@lista1.get(25)</div>
										<input type="text" class="cantidad form-control height23px right width80px"
											name="cantidad[]"
											id="cantidad_@lista1.get(0)"
											value="@lista1.get(10)"
											onfocus="value=value.replace(/,/g,''); cantAux = value;" 
											onblur = "value = formatStandar(value, '2');"
											onkeypress="return ingresoDouble(event,value)"
											autocomplete="off"
											onchange="if(value=='') value=0; calculaLinea('@lista1.get(0)', '@lista1.get(20)');">
									</td>
									<td style="text-align:center;">
										<input type="hidden" name="esVenta[]" id="esVenta_@lista1.get(0)"  value="@lista1.get(11)">
										@if(lista1.get(11).equals("0")){
											<input type="checkbox" id="checkbox_@lista1.get(0)" onchange="checkVenta('@lista1.get(0)'); calculaLinea('@lista1.get(0)', '@lista1.get(20)');">
										}else{
											<input type="checkbox" id="checkbox_@lista1.get(0)" onchange="checkVenta('@lista1.get(0)'); calculaLinea('@lista1.get(0)', '@lista1.get(20)');" checked>
										}
									</td>
									<td style="text-align:center;">@lista1.get(4)</td>
									<td style="text-align:center;">
										<div style="display:none" id="hiddenpuVentaRepos_@lista1.get(0)">@lista1.get(26)</div>
										<input type="text" class="form-control height23px right width100px"
											name="puVentaRepos[]"
											id="puVentaRepos_@lista1.get(0)"
											value="@lista1.get(5)"
											onfocus="value=value.replace(/,/g,'');" 
											onblur = "value = formatStandar(value, '@lista1.get(20)');"
											onkeypress="return ingresoDouble(event,value)"
											autocomplete="off"
											onchange="if(value=='') {value=0;} else {calculaTasa(1,'@lista1.get(0)', '@lista1.get(20)'); calculaLinea('@lista1.get(0)', '@lista1.get(20)');}">
									</td>
									<td style="text-align:center;">
										<input type="hidden" id="id_unidadTiempo_@lista1.get(0)" name="id_unidadTiempo[]" value="@lista1.get(9)">
										<select class="custom-select"  style="width: 80px;"
											onchange="$('#id_unidadTiempo_@lista1.get(0)').val(value);">
											<option value="@lista1.get(9)">@lista1.get(6)</option>
											@for(lista <- listUnTiempo){
												<option value="@lista.id">@lista.nombre</option>
											}
										</select>
									</td>
									<td>
										<div style="display:none" id="hiddentasaArr_@lista1.get(0)">@lista1.get(27)</div>
										<input type="text" class="tasaGlobal form-control height23px right width80px"
											id="tasaArr_@lista1.get(0)"
											value="@lista1.get(24)"
											onfocus="value=value.replace(/,/g,'').replace(/%/g,'').replace(/ /g,'')"
											onblur = "value = formatPorcentaje(value);"
											onkeypress="return ingresoDouble(event,value)"
											autocomplete="off"
											onchange="if(value=='') {value='0.00 %';} else {calculaTasa(2,'@lista1.get(0)', '@lista1.get(20)'); calculaLinea('@lista1.get(0)', '@lista1.get(20)');}">
									</td>
									<td style="text-align:center;">
										<div style="display:none" id="hiddenpuArriendo_@lista1.get(0)">@lista1.get(28)</div>
										<input type="text" class="factorGlobal form-control height23px right width80px"
											name="puArriendo[]"
											id="puArriendo_@lista1.get(0)"
											value="@lista1.get(7)"
											onfocus="value=value.replace(/,/g,'');" 
											onblur = "value = formatStandar(value, '@lista1.get(20)');"
											onkeypress="return ingresoDouble(event,value)"
											autocomplete="off"
											onchange="if(value=='') {value=0;} else {calculaTasa(1,'@lista1.get(0)', '@lista1.get(20)'); calculaLinea('@lista1.get(0)', '@lista1.get(20)');}">
									</td>
									<td style="text-align:center;">
										<div style="display:none" id="hiddenpermanencia_@lista1.get(0)">@lista1.get(29)</div>
										<input type="text" class="form-control height23px right"
											name="permanencia[]"
											id="permanencia_@lista1.get(0)"
											value="@lista1.get(12)"
											onfocus="value=value.replace(/,/g,'');" 
											onblur = "$('#hiddenpermanencia_@lista1.get(0)').text(value); value = formatStandar(value, '2');"
											onkeypress="return ingresoDouble(event,value)"
											autocomplete="off"
											onchange="if(value=='') value=0; calculaLinea('@lista1.get(0)', '@lista1.get(20)');">
									</td>
									
									
								
									<td class="totRepos" style="text-align:right;" id="totRepos_@lista1.get(0)">@lista1.get(13)</td>
									<td class="totArrie" style="text-align:right;" id="totArrie_@lista1.get(0)">@lista1.get(14)</td>
									<td class="totVenta" style="text-align:right;" id="totVenta_@lista1.get(0)">@lista1.get(15)</td>
									<td class="totKg" style="text-align:right;" id="totKg_@lista1.get(0)">@lista1.get(18)</td>
									@if(mapPermiso.get("parametro.escondeLosM2")!=null && mapPermiso.get("parametro.escondeLosM2").equals("1")) {
										<td class="totM2" style="display:none; text-align:right;" id="totM2_@lista1.get(0)">@lista1.get(19)</td>
									}else{
										<td class="totM2" style = "text-align:right;" id="totM2_@lista1.get(0)">@lista1.get(19)</td>
									}
									
									
									<td style = "display:none" id="uniKg_@lista1.get(0)">@lista1.get(16)</td>
									<td style = "display:none" id="uniM2_@lista1.get(0)">@lista1.get(17)</td>
									<td style = "display:none" id="idEquipo_@lista1.get(0)">@lista1.get(0)</td>
									<td style = "display:none" id="nroDecimales_@lista1.get(0)">@lista1.get(20)</td>
									
								</TR>
				 			}
						</tbody>
						<tfoot id="tfoot" style="background-color: #eeeeee; display:none">
							<TR> 
								<TH colspan="13" style= "text-align: right;">SUB-TOTALES </TH>
								<TH style="text-align:right;"><div id="subtotalRepos">0.00</div></TH>
								<TH style="text-align:right;"><div id="subtotalArrie">0.00</div></TH>
								<TH style="text-align:right;"><div id="subtotalVenta">0.00</div></TH>
								<TH></TH>
								@if(mapPermiso.get("parametro.escondeLosM2")!=null && mapPermiso.get("parametro.escondeLosM2").equals("1")) {
									<TH style = "display:none"></TH>
								}else{
									<TH></TH>
								}
								<TH style = "display:none"></TH>
								<TH style = "display:none"></TH>
								<TH style = "display:none"></TH>
							</TR>
							<TR> 
								<TH colspan="13" style="text-align:right;">DESCUENTOS</TH>
								<TH style="text-align:right;"></TH>
								<TH style="text-align:center;">
									<input type="text" class="form-control height23px right"
										id="dctoArriendo"
										name="dctoArriendo"
										value="@formCotiza.dctoArriendo %"
										onfocus="value=value.replace(/,/g,'').replace(/%/g,'').replace(/ /g,'')" 
										onblur = "value = formatPorcentaje(value);"
										onkeypress="return ingresoDouble(event,value)"
										onchange="sumaTotales(); dctoObligado=1;">
									</td>
								</TH>
								<TH style="text-align:center;">
									<input type="text" class="form-control height23px right"
										id="dctoVenta"
										name="dctoVenta"
										value="@formCotiza.dctoVenta %"
										onfocus="value=value.replace(/,/g,'').replace(/%/g,'').replace(/ /g,'')" 
										onblur = "value = formatPorcentaje(value);"
										onkeypress="return ingresoDouble(event,value)"
										onchange="sumaTotales(); dctoObligado=1;">
									</td>
								</TH>
								<TH></TH>
								
								@if(mapPermiso.get("parametro.escondeLosM2")!=null && mapPermiso.get("parametro.escondeLosM2").equals("1")) {
									<TH style = "display:none"></TH>
								}else{
									<TH></TH>
								}
								<TH style = "display:none"></TH>
								<TH style = "display:none"></TH>
								<TH style = "display:none"></TH>
							</TR>
							<TR>
								<TH colspan="5" style= "text-align: right;">Total cantidad</TH>
								<TH colspan="1" style= "text-align: right;"><div id="granTotCant">0.00</div></TH>
								<TH colspan="7" style= "text-align: right;">TOTALES </TH>
								<TH style="text-align:right;"><div id="granTotRepos">0.00</div></TH>
								<TH style="text-align:right;"><div id="granTotArrie">0.00</div></TH>
								<TH style="text-align:right;"><div id="granTotVenta">0.00</div></TH>
								<TH style="text-align:right;"><div id="granTotKg">0.00</div></TH>
								@if(mapPermiso.get("parametro.escondeLosM2")!=null && mapPermiso.get("parametro.escondeLosM2").equals("1")) {
									<TH style="display:none; text-align:right;"><div id="granTotM2">0.00</div></TH>
								}else{
									<TH style = "text-align:right;"><div id="granTotM2">0.00</div></TH>
								}
								
								<TH style = "display:none"></TH>
								<TH style = "display:none"></TH>
								<TH style = "display:none"></TH>
							</TR>
					</tfoot>
					</table>
				</div>
			</div>
			
			
			<div class="noprint" align="left">
					<div class="col-xs-5 col-sm-1 col-md-1 col-lg-1">
						<input type="button"  id="agregarEquipo" value='AgregarEquipo' class="btn btn-success btn-sm rounded-pill btn-block" onclick="agregaNuevoEquipo();" >
					</div>
				<div class="row justify-content-md-center" >
					<div class="col-xs-5 col-sm-1 col-md-1 col-lg-1">
						<input type="button"  value="Cancelar" class="btn btn-light btn-sm rounded-pill btn-block" onclick="location.href='/home/';">
					</div>
					<div class="col-xs-5 col-sm-1 col-md-1 col-lg-1">
						<input type="button"  id="verifica" value='Verificar' class="btn btn-success btn-sm rounded-pill btn-block" onclick="verificaCotizacion();" >
					</div>
					<div class="col-xs-5 col-sm-1 col-md-1 col-lg-1">
						<input type="button"  id="modifica" value='Modificar' class="btn btn-warning btn-sm rounded-pill btn-block" onclick="modificaCotizacion();" style="visibility:hidden">
					</div>
					<div class="col-xs-5 col-sm-1 col-md-1 col-lg-1">
						<input type="submit" id="aplica" value='Generar Cotización' class="btn btn-primary btn-sm rounded-pill btn-block" style="visibility:hidden">
					</div>
				</div>
			</div>
			
		</div>
	</form>
	
	<div id="listaCliente" class="modal" role="dialog" data-backdrop="static" data-keyboard="false">
		<div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">SELECCIONAR CLIENTE</h5>
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				          <span aria-hidden="true">&times;</span>
				        </button>
				</div>
				<div class="modal-body">
					<div class="noprint" align="center">
						<a href="#" onclick="$('#listaCliente').modal('hide'); $('#modalClienteNuevo').modal('show');">
							<kbd style="background-color: #73C6B6">Agregar Nuevo</kbd>
						</a>
					</div>
					<table id="tablaListaClientes" class="table table-sm table-bordered table-condensed table-hover table-fluid">
						<thead style="background-color: #eeeeee">
							<TR> 
								<TH>@mapDiccionario.get("RUT")</TH>
								<TH>NICK</TH>
								<TH>NOMBRE</TH>
							</TR>
						</thead>
						<tbody>
							@for(lista1 <- listClientes){
								<TR onClick="$('#id_cliente').val(@lista1.getId()); $('#rutCliente').val('@lista1.getRut()');$('#nombreCliente').val('@lista1.getNickName()');" data-dismiss="modal">
									<td  style="text-align:left;">@lista1.getRut()</td>
									<td  style="text-align:left;">@lista1.getNickName()</td>
									<td  style="text-align:left;">@lista1.getNombre()</td>
								</TR>
				 			}
						</tbody>
					</table>
	   				<div class="row">
						<div class="col-sm-12" style="text-align:center">
							<button type="button" class="btn btn-sm  btn-warning" style="font-size: 10px;" data-dismiss="modal">Cancelar</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div id="listaProyecto" class="modal" role="dialog" data-backdrop="static" data-keyboard="false">
		<div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">SELECCIONAR PROYECTO</h5>
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				          <span aria-hidden="true">&times;</span>
				        </button>
				</div>
				<div class="modal-body">
					<div class="noprint" align="center">
						<a href="#" onclick="$('#listaProyecto').modal('hide'); $('#modalProyectoNuevo').modal('show');">
							<kbd style="background-color: #73C6B6">Agregar Nuevo</kbd>
						</a>
					</div>
					<table id="tablaListaProyectos" class='table table-sm table-bordered table-condensed table-hover table-fluid'>
						<thead style="background-color: #eeeeee">
							<TR>
								<TH>NICK</TH>
								<TH>NOMBRE</TH>
								<TH>@mapDiccionario.get("Comuna")</TH>
							</TR>
						</thead>
						<tbody>
							@for(lista1 <- listProyectos){
								<TR onClick="$('#id_proyecto').val(@lista1.getId()); $('#nombreProyecto').val('@lista1.getNickName()');" data-dismiss="modal">
									<td  style="text-align:left;">@lista1.getNickName()</td>
									<td  style="text-align:left;">@lista1.getNombre()</td>
									<td  style="text-align:left;">@lista1.getComuna()</td>
								</TR>
				 			}
						</tbody>
					</table>
	   				<div class="row">
						<div class="col-sm-12" style="text-align:center">
							<button type="button" class="btn btn-sm  btn-warning" style="font-size: 10px;" data-dismiss="modal">Cancelar</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div id="modalListaCotizacion" class="modal" role="dialog" data-backdrop="static" data-keyboard="false">
		<div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">COTIZACIONES DISPONIBLES</h5>
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				          <span aria-hidden="true">&times;</span>
				        </button>
				</div>
				<div class="modal-body">
					<div id="vistaModListaCotizacion"></div>
	   				<div class='row'>
						<div class='col-sm-12' style='text-align:center'>
							<button type='button' class='btn btn-sm  btn-warning' style='font-size: 10px;' data-dismiss='modal'>Cancelar</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div id="modalCargaMasiva" class="modal" role="dialog" data-backdrop="static" data-keyboard="false">
	  <div class="modal-dialog modal-sm modal-dialog-scrollable" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title">Carga masiva de equipos</h5>
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	          <span aria-hidden="true">&times;</span>
	        </button>
	      </div>
	      <div class="modal-body">
	        
			<div class="row">
				<div class="col-sm-12" style="text-align:center">
					<form action="/cotiPlantilla/" method="POST"  onsubmit="return validarForm2();">
						<button type="submit" id="btnSubmit2" class="btn btn-sm  btn-success" style="font-size: 10px;">DESCARGAR PLANTILLA</button>
					</form>
					<br>
					<form id="cotiValidarPlantilla" action="/routes2/cotiValidarPlantillaSel/" method="POST" enctype="multipart/form-data">
						<input type="hidden" id="formSucursal" name="id_sucursal" value="@sucursal.getId()">
						<span class="btn btn-info btn-sm btn-file" style="font-size: 8px;">
							<div>SUBIR ARCHIVO</div>
							<input type="hidden" id="id_bodegaEmpresa" name="id_bodegaEmpresa" value="@formCotiza.id_bodegaEmpresa">
							<input type="file" id="archivoXLSX" name="archivoXLSX" value="" onchange="subirArchivo(this.form, this.form.archivoXLSX.value)">
						</span>
					</form>
					<br>
					<button type="button" class="btn btn-sm  btn-warning" style="font-size: 10px;" data-dismiss="modal">Cancelar</button>
				</div>
			</div>
			<br>
	      </div>
	    </div>
	  </div>
	</div>
	
	<form id="copyCotizacion" action="/routes2/cotizaModificaJsonSel/" method="POST" enctype="multipart/form-data">
		<input type="hidden" id="formCotizacion" name="id_cotizacion" value="0">
	</form>
	
	<div id="modalListaEquipos" class="modal" role="dialog" data-backdrop="static" data-keyboard="false">
		<div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">LISTADO DE EQUIPOS (SELECT)</h5>
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				          <span aria-hidden="true">&times;</span>
				        </button>
				</div>
				<div class="modal-body">
					<div id="vistalistadoEquipos"></div>
	   				<div class="row justify-content-md-center" >
						<div class="col-xs-5 col-sm-2 col-md-2 col-lg-2">
							<button type='button' class='btn btn-sm btn-warning rounded-pill btn-block' style='font-size: 10px;' data-dismiss='modal'>Cancelar</button>
						</div>
						<div class="col-xs-5 col-sm-2 col-md-2 col-lg-2">
							<button type="button" class="btn btn-sm btn-primary rounded-pill btn-block" style='font-size: 10px;' data-dismiss='modal' onclick="agregarEquipos()">SELECCIONAR</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div id="modalStockPorEquipo" class="modal" role="dialog" data-backdrop="static" data-keyboard="false">
		<div class='modal-dialog modal-dialog-scrollable' style='max-width: 80% !important;' role='document'>
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">STOCK DISPONIBLE</h5>
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				          <span aria-hidden="true">&times;</span>
				        </button>
				</div>
				<div class="modal-body">
					<div id="stockPorEquipo"></div>
	   				<div class="row">
						<div class="col-sm-12" style="text-align:center">
							<button type="button" class="btn btn-sm  btn-warning" style="font-size: 10px;" data-dismiss="modal">Cancelar</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	
}



<script type="text/javascript">

	$(document).ready(function() {
		$('#tablaListaClientes').DataTable({
	    	"fixedHeader": true,
	    	"lengthMenu": [[20, 50, 100, 200, -1], [20, 50, 100, 200, "All"]],
	    	"order": [[ 1, "asc" ]],
	    	"language": {
	        	"url": "https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
	        }
	  	} );

		$('#tablaListaProyectos').DataTable({
	    	"fixedHeader": true,
	    	"lengthMenu": [[20, 50, 100, 200, -1], [20, 50, 100, 200, "All"]],
	    	"order": [[ 0, "asc" ]],
	    	"language": {
	        	"url": "https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
	        }
	  	} );

		sumaTotales();
		
		$('#tablaPrincipal').DataTable({
		    	"fixedHeader": true,
		    	"lengthMenu": [[15, 50, 100, 200, -1], [15, 50, 100, 200, "All"]],
		    	"order": [[ 0, "asc" ],[ 2, "asc" ]],
		    	"language": {
		        	"url": "https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
		        }
		} );
		
		
		  
		document.getElementById('mostrarmostrar').style.display="block";
	});
	
	const validarNumero = (numero) =>{
		var formData = new FormData();
		formData.append('numeroCoti',numero);
        $.ajax({
            url: "/existeNumeroCotizacionAjax/",
            type: "POST",
            method: "POST",
            data: formData,
            cache: false,
            contentType: false,
	     	processData: false,
	     	success: function(respuesta){
				if(respuesta!="OK"){
					$("#numeroCoti").val("@formCotiza.numeroCoti");
					alertify.alert(respuesta, function () { });
				}
	     	}
        });
	}
	
	const vistaStockPorEquipo = (id_equipo) =>{
		var formData = new FormData();
		formData.append('id_equipo',id_equipo);
        $.ajax({
            url: "/tablaInvPorEquipoAjax/",
            type: "POST",
            method: "POST",
            data: formData,
            cache: false,
            contentType: false,
	     	processData: false,
	     	success: function(respuesta){
				document.getElementById('stockPorEquipo').innerHTML = respuesta;
				$('#modalStockPorEquipo').modal('show');
	     	}
        });
	}
	
	
	const sumaTotales = () =>{
		$("#tablaPrincipal").dataTable().fnDestroy();
		let tabla = document.getElementById("tablaPrincipal");
		let totCant = 0;
		
		let cant = 0;
		$(".cantidad").each(function() {
			let val = $(this).val().replace(/,/g,'');
			cant += parseFloat(val);
		});
		
		let repos = 0;
		$(".totRepos").each(function() {
			let val = $(this).text().replace(/,/g,'');
			repos += parseFloat(val);
		}); $("#subtotalRepos").text(formatStandar(repos,'@numDecParaTot'));
		
		let arr = 0;
		$(".totArrie").each(function() {
			let val = $(this).text().replace(/,/g,'');
			arr += parseFloat(val);
		}); $("#subtotalArrie").text(formatStandar(arr,'@numDecParaTot'));
		
		let vta = 0;
		$(".totVenta").each(function() {
			let val = $(this).text().replace(/,/g,'');
			vta += parseFloat(val);
		}); $("#subtotalVenta").text(formatStandar(vta,'@numDecParaTot'));
		
		let kg = 0;
		$(".totKg").each(function() {
			let val = $(this).text().replace(/,/g,'');
			kg += parseFloat(val);
		});
		
		let m2 = 0;
		$(".totM2").each(function() {
			let val = $(this).text().replace(/,/g,'');
			m2 += parseFloat(val);
		});
		
		let dctoArriendo = $("#dctoArriendo").val().replace(/,/g,'').replace("%","").trim();
		let dctoVenta = $("#dctoVenta").val().replace(/,/g,'').replace("%","").trim();
		
		$("#granTotRepos").text(formatStandar(repos,'@numDecParaTot'));
		$("#granTotArrie").text(formatStandar((arr*(1-dctoArriendo/100)),'@numDecParaTot'));
		$("#granTotVenta").text(formatStandar((vta*(1-dctoVenta/100)),'@numDecParaTot'));
		$("#granTotKg").text(formatStandar(kg,2));
		$("#granTotM2").text(formatStandar(m2,2));
		$("#granTotCant").text(formatStandar(cant,2));
		
	}
	
	const checkVenta = (id_equipo) =>{
		let esVenta = $("#esVenta_"+id_equipo).val();
		if(esVenta==0){
			$("#esVenta_"+id_equipo).val('1');
		}else{
			$("#esVenta_"+id_equipo).val('0');
		}
	}
	
	let calculaTasa = (flag, id_equipo, numDec) => {
		if(flag==1){
			let uniVta = $("#puVentaRepos_"+id_equipo).val().replace(/,/g,'');
			let uniArr = $("#puArriendo_"+id_equipo).val().replace(/,/g,'');
			let uniTasa = parseFloat(uniArr)/parseFloat(uniVta);
			$("#tasaArr_"+id_equipo).val(formatStandar(uniTasa * 100,2)+" %");
			$("#hiddentasaArr_"+id_equipo).text(uniTasa);
		}else if(flag==2){
			let uniVta = $("#puVentaRepos_"+id_equipo).val().replace(/,/g,'');
			let uniTasa = $("#tasaArr_"+id_equipo).val().replace(/,/g,'').replace(/%/g,'').replace(/ /g,'');
			let uniArr = parseFloat(uniVta)*parseFloat(uniTasa)/100;
			$("#puArriendo_"+id_equipo).val(formatStandar(uniArr,numDec));
			$("#hiddentasaArr_"+id_equipo).text(uniTasa);
		}else{
			let uniVta = $("#puVentaRepos_"+id_equipo).val().replace(/,/g,'');
			let uniArr = $("#puArriendo_"+id_equipo).val().replace(/,/g,'');
			let uniTasa = parseFloat(uniArr)/parseFloat(uniVta);
			$("#tasaArr_"+id_equipo).val(formatStandar(uniTasa * 100,2)+" %");
			$("#hiddentasaArr_"+id_equipo).text(uniTasa);
		}
		
	}
	
	const calculaLinea = (id_equipo, numDec) =>{
		let cant = $("#cantidad_"+id_equipo).val().replace(/,/g,'');
		let ckeckEsVta = $("#checkbox_"+id_equipo).val();
		let esVenta = $("#esVenta_"+id_equipo).val();
		let uniVta = $("#puVentaRepos_"+id_equipo).val().replace(/,/g,'');
		let uniArr = $("#puArriendo_"+id_equipo).val().replace(/,/g,'');
		let perm = $("#permanencia_"+id_equipo).val().replace(/,/g,'');
		let uniKg = $("#uniKg_"+id_equipo).text().replace(/,/g,'');
		let uniM2 = $("#uniM2_"+id_equipo).text().replace(/,/g,'');
		let totRepos = parseFloat(cant) * parseFloat(uniVta);
		let totArr = 0;
		let totVta = 0;
		let totKg = 0;
		let totM2 = 0;
		if(esVenta == 0){
			 totRepos = parseFloat(cant) * parseFloat(uniVta);
			 totArr = parseFloat(cant) * parseFloat(perm) * parseFloat(uniArr);
			 totVta = 0;
			 totKg = parseFloat(cant) * parseFloat(uniKg);
			 totM2 = parseFloat(cant) * parseFloat(uniM2);
		}else{
			 totRepos = 0;
			 totArr = 0;
			 totVta = parseFloat(cant) * parseFloat(uniVta);
			 totKg = parseFloat(cant) * parseFloat(uniKg);
			 totM2 = parseFloat(cant) * parseFloat(uniM2);
		}
		$("#cantidad_"+id_equipo).val(formatStandar(cant,2));
		$("#puVentaRepos_"+id_equipo).val(formatStandar(uniVta,numDec));
		$("#puArriendo_"+id_equipo).val(formatStandar(uniArr,numDec));
		$("#totRepos_"+id_equipo).text(formatStandar(totRepos,numDec));
		$("#totArrie_"+id_equipo).text(formatStandar(totArr,numDec));
		$("#totVenta_"+id_equipo).text(formatStandar(totVta,numDec));
		$("#totKg_"+id_equipo).text(formatStandar(totKg,2));
		$("#totM2_"+id_equipo).text(formatStandar(totM2,2));
		
		
		$("#hiddencantidad_"+id_equipo).text(cant);
		$("#hiddenpuVentaRepos_"+id_equipo).text(uniVta);
		$("#hiddenpuArriendo_"+id_equipo).text(uniArr);
		
		
		
		if(verificando == 1){
			sumaTotales();
		}
		
	}
	
	let verificando = 0;
	const verificaCotizacion = () =>{
		document.getElementById("btnCopiaCoti").style.display = "none";
		document.getElementById("btnCargaExcel").style.display = "none";
		sumaTotales();
		let granTotRepos = $("#granTotRepos").text().replace(/,/g,'');
		let granTotArrie = $("#granTotArrie").text().replace(/,/g,'');
		let granTotVenta = $("#granTotVenta").text().replace(/,/g,'');
		let sumaAux = parseFloat(granTotRepos) + parseFloat(granTotArrie) + parseFloat(granTotVenta);
		if(sumaAux > 0){
			let tabla = document.getElementById("tablaPrincipal");
			for(i=2; i<tabla.rows.length-3; i++){
				let cant = $(".cantidad",tabla.rows[i].cells[5]).val().replace(/,/g,'');
				let arr = tabla.rows[i].cells[13].innerHTML.replace(/,/g,'');
				let vta = tabla.rows[i].cells[14].innerHTML.replace(/,/g,'');
				if((parseFloat(cant)+parseFloat(arr)+parseFloat(vta))<=0){
					tabla.rows[i].style.display = 'none';
				}
			}
			verificando = 1;
			document.getElementById('tfoot').style.display = '';
			document.getElementById('modifica').style.visibility = 'visible';
			document.getElementById('aplica').style.visibility = 'visible';
			document.getElementById('verifica').style.visibility = 'hidden';
			

			document.getElementById('selSucursal').disabled = true;
			document.getElementById('selComercial').disabled = true;
			$('#btnAplicarTasa').hide();
			$('#btnAplicarFactor').hide();
			
	
		}else{
			$('#tablaPrincipal').DataTable({
		    	"fixedHeader": true,
		    	"lengthMenu": [[15, 50, 100, 200, -1], [15, 50, 100, 200, "All"]],
		    	"order": [[ 0, "asc" ],[ 2, "asc" ]],
		    	"language": {
		        	"url": "https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
		        }
			} );
			alertify.alert('NO PUEDE VERIFICAR UNA COTIZACION SIN CANTIDADES', function () { });
		}
	}
	
	const modificaCotizacion = () =>{
		let tabla = document.getElementById("tablaPrincipal");
		for(i=2; i<tabla.rows.length-3; i++){
			tabla.rows[i].style.display = '';
		}
		$('#tablaPrincipal').DataTable({
		    	"fixedHeader": true,
		    	"lengthMenu": [[15, 50, 100, 200, -1], [15, 50, 100, 200, "All"]],
		    	"order": [[ 0, "asc" ],[ 2, "asc" ]],
		    	"language": {
		        	"url": "https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
		        }
		} );
		document.getElementById('tfoot').style.display = 'none';
		document.getElementById('modifica').style.visibility = 'hidden';
		document.getElementById('aplica').style.visibility = 'hidden';
		document.getElementById('verifica').style.visibility = 'visible';
		document.getElementById('selSucursal').disabled = false;
		document.getElementById('selComercial').disabled = false;
		$('#btnAplicarTasa').show();
		$('#btnAplicarFactor').show();
		verificando = 0;
	}
	
	let importDesdeOtraCoti = "0";
	const seleccionaCotizacion = (id_cotizacion) =>{
		document.getElementById("btnCopiaCoti").style.display = "none";
		document.getElementById("btnCargaExcel").style.display = "none";
		$("#formCotizacion").val(id_cotizacion);
		$("#copyCotizacion").submit();
	}
	
	if("@importDesdeExcel" == "1"){
		document.getElementById("btnCopiaCoti").style.display = "none";
		document.getElementById("btnCargaExcel").style.display = "none";
	}
	
	
	
	let dctoObligado = 0;
	const validarForm = () =>{
		$("#aplica").attr('disabled',true);
		let flag = true;
		sumaTotales();
		let granTotRepos = $("#granTotRepos").text().replace(/,/g,'');
		let granTotArrie = $("#granTotArrie").text().replace(/,/g,'');
		let granTotVenta = $("#granTotVenta").text().replace(/,/g,'');
		let sumaAux = parseFloat(granTotRepos) + parseFloat(granTotArrie) + parseFloat(granTotVenta);
		
		
		if(sumaAux <= 0){
			flag = false;
			alertify.alert('NO PUEDE GENERAR UNA COTIZACION SIN CANTIDADES', function () {
				$("#aplica").attr('disabled',false);
				return(flag);
     		});
		}else if($("#id_cliente").val()=='0'){
			flag = false;
			alertify.alert('NO PUEDE GENERAR UNA COTIZACION SIN ASIGNAR UN CLIENTE', function () {
				$("#aplica").attr('disabled',false);
				return(flag);
     		});
		}else if(dctoObligado==0 && '@mapDiccionario.get("nEmpresa")' == 'MONTAX'){
			flag = false;
			alertify.alert('ESTA OBLIGADO A INGRESAR UN DESCUENTO, SI NO APLICA DESCUENTO INGREZAR UN CERO', function () {
				$("#aplica").attr('disabled',false);
				return(flag);
     		});
		}else if ((sumaAux-parseFloat(granTotRepos))<=0){
			flag = false;
			alertify.alert('NO PUEDE GENERAR UNA COTIZACION QUE SUMA CERO, REVISAR PERMANENCIA', function () {
				$("#aplica").attr('disabled',false);
				return(flag);
     		});
		}else{
			let tabla = document.getElementById("tablaPrincipal");
			for(i=2; i<tabla.rows.length-3; i++){
				let cant = $(".cantidad",tabla.rows[i].cells[5]).val().replace(/,/g,'');
				let arr = tabla.rows[i].cells[13].innerHTML.replace(/,/g,'');
				let vta = tabla.rows[i].cells[14].innerHTML.replace(/,/g,'');
				if((parseFloat(cant)+parseFloat(arr)+parseFloat(vta))<=0){
					tabla.deleteRow(i);
					i--;
				}
			}
			return(true);
		}
		return(flag);
	}

	let extArray = new Array(".gif", ".jpg", ".png", ".jpeg", ".pdf", ".xls", ".doc", ".xlsx", ".docx", ".tar", ".zip", ".rar");
	const LimitAttach = (form, file) => {
		let allowSubmit = false;
		if (!file) return;
		while (file.indexOf("\\") != -1){
			file = file.slice(file.indexOf("\\") + 1);
		}
		let extencion = file.slice(file.lastIndexOf(".")).toLowerCase();
		for (var i = 0; i < extArray.length; i++) {
			if (extArray[i] == extencion) { allowSubmit = true; break; }
		}
		if (allowSubmit) {
			var file = $("#docAdjunto")[0].files[0];
			var fileSize = file.size; //tamaño del archivo
			if(fileSize>100000000){
				alert("Se permiten únicamente archivos que no superen los 100 MB,"
				+" el que se intenta subir pesa: "+Math.round(file.size/10)/100+" KB");
				form.docAdjunto.value="";
			}else{
				alert("Documento subido con éxito");
				$("#txtBtn").text("Cambiar Documento");
			}
		}else{
			alert("Se permiten únicamente archivos con la extención: " 
			+ (extArray.join("  ")) + "\nPor favor, seleccione otro archivo "
			+ "e intente de nuevo.");
			form.docAdjunto.value="";
		}
	}
	
	let extArray2 = new Array(".xls", ".xlsx");
	function subirArchivo(form, file) {
		allowSubmit = false;
		if (!file) return;
		while (file.indexOf("\\") != -1)
			file = file.slice(file.indexOf("\\") + 1);
		ext = file.slice(file.lastIndexOf(".")).toLowerCase();
		for (var i = 0; i < extArray2.length; i++) {
			if (extArray2[i] == ext) { allowSubmit = true; break; }
		}
		if (allowSubmit) {
			$("#cotiValidarPlantilla").submit();
		}else{
			alertify.alert("Se permiten &uacute;nicamente archivos con la extenci&oacute;n: " 
			+ (extArray2.join("  ")) + "\nPor favor, seleccione otro archivo "
			+ "e intente de nuevo.");
			form.archivoXLSX.value="";
		}
	}

	const aplicarTasaGlobal = () => {
		$("#tablaPrincipal").dataTable().fnDestroy();
		$(".tasaGlobal").each(function() {
			 $(this).val($("#tasaGlobal").val());
		});
		let tasa = $("#tasaGlobal").val();
		tasa = tasa.replace(/,/g,'').replace(/%/g,'').replace(/ /g,'');
		let tabla = document.getElementById("tablaPrincipal");
		for(i=2; i<tabla.rows.length-3; i++){
			let id_equipo = tabla.rows[i].cells[20].innerHTML;
			let nroDecimal = tabla.rows[i].cells[21].innerHTML;
			let prepos = $("#puVentaRepos_"+id_equipo).val().replace(/,/g,'');
			$("#puArriendo_"+id_equipo).val(formatStandar(parseFloat(prepos*tasa/100),nroDecimal));
			calculaLinea(id_equipo,nroDecimal);
		}
		sumaTotales();
		document.getElementById('selSucursal').disabled = true;
		document.getElementById('selComercial').disabled = true;
		$('#tablaPrincipal').DataTable({
	    	"fixedHeader": true,
	    	"lengthMenu": [[15, 50, 100, 200, -1], [15, 50, 100, 200, "All"]],
	    	"order": [[ 0, "asc" ],[ 2, "asc" ]],
	    	"language": {
	        	"url": "https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
	        }
		});
	}
	
	const aplicarFactorGlobal = () => {
		$("#tablaPrincipal").dataTable().fnDestroy();
		let factorGlobal = $("#factorGlobal").val();
		factorGlobal = factorGlobal.replace(/,/g,'');
		let tabla = document.getElementById("tablaPrincipal");
		for(i=2; i<tabla.rows.length-3; i++){
			let id_equipo = tabla.rows[i].cells[20].innerHTML;
			let nroDecimal = tabla.rows[i].cells[21].innerHTML;
			let pArr = $("#puArriendo_"+id_equipo).val().replace(/,/g,'');
			let prepos = $("#puVentaRepos_"+id_equipo).val().replace(/,/g,'');
			$("#puArriendo_"+id_equipo).val(formatStandar(parseFloat(pArr*factorGlobal),nroDecimal));
			if(parseFloat(prepos)>0){
				$("#tasaArr_"+id_equipo).val(formatStandar(parseFloat(pArr*factorGlobal/prepos*100),2) + "%");
			}
			calculaLinea(id_equipo,nroDecimal);
		}
		sumaTotales();
		document.getElementById('selSucursal').disabled = true;
		document.getElementById('selComercial').disabled = true;
		$('#tablaPrincipal').DataTable({
	    	"fixedHeader": true,
	    	"lengthMenu": [[15, 50, 100, 200, -1], [15, 50, 100, 200, "All"]],
	    	"order": [[ 0, "asc" ],[ 2, "asc" ]],
	    	"language": {
	        	"url": "https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
	        }
		});
	}
	
	const aplicarFactorGlobalRepos = () => {
		$("#tablaPrincipal").dataTable().fnDestroy();
		let factorGlobalRepos = $("#factorGlobalRepos").val();
		factorGlobalRepos = factorGlobalRepos.replace(/,/g,'');
		let tabla = document.getElementById("tablaPrincipal");
		for(i=2; i<tabla.rows.length-3; i++){
			let id_equipo = tabla.rows[i].cells[20].innerHTML;
			let nroDecimal = tabla.rows[i].cells[21].innerHTML;
			let pArr = $("#puArriendo_"+id_equipo).val().replace(/,/g,'');
			let prepos = $("#puVentaRepos_"+id_equipo).val().replace(/,/g,'');
			prepos = prepos * factorGlobalRepos;
			$("#puVentaRepos_"+id_equipo).val(formatStandar(parseFloat(prepos),nroDecimal));
			if(parseFloat(prepos*factorGlobalRepos)>0){
				$("#tasaArr_"+id_equipo).val(formatStandar(parseFloat(pArr/prepos*100),2) + "%");
			}
			calculaLinea(id_equipo,nroDecimal);
		}
		sumaTotales();
		document.getElementById('selSucursal').disabled = true;
		document.getElementById('selComercial').disabled = true;
		$('#tablaPrincipal').DataTable({
	    	"fixedHeader": true,
	    	"lengthMenu": [[15, 50, 100, 200, -1], [15, 50, 100, 200, "All"]],
	    	"order": [[ 0, "asc" ],[ 2, "asc" ]],
	    	"language": {
	        	"url": "https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
	        }
		});
	}
	
	const actualizaComerciales = (id_sucursal) =>{
		var formData = new FormData();
		formData.append('id_sucursal',id_sucursal);
        $.ajax({
            url: "/actualizaComercialesAjax/",
            type: "POST",
            method: "POST",
            data: formData,
            cache: false,
            contentType: false,
	     	processData: false,
	     	success: function(respuesta){
				document.getElementById('actualComerciales').innerHTML = respuesta;
				$("#formSucursal").val(id_sucursal);
	     	}
        });	
	}
	
	const actualizaPrecios = (id_sucursal) =>{
		document.getElementById('bloquear2').style.display="block";
			var formData = new FormData();
			formData.append('id_sucursal',id_sucursal);
	        $.ajax({
	            url: "/actualizaPreciosAjax/",
	            type: "POST",
	            method: "POST",
	            data: formData,
	            cache: false,
	            contentType: false,
		     	processData: false,
		     	success: function(rs){
			
					$("#tablaPrincipal").dataTable().fnDestroy();
					
					let tabla = document.getElementById("tablaPrincipal");
					
					for(i=2; i<tabla.rows.length-3; i++){
						let id_equipo = tabla.rows[i].cells[20].innerHTML;
						let nroDecimal = tabla.rows[i].cells[21].innerHTML;
						
						for(let i=0; i<rs.length; i++){
							if(rs[i].id_equipo == id_equipo){
								let puVentaRepos = rs[i].precioVenta;
								let puArriendo = rs[i].precioArriendo;
								let tasaArriendo = 0
								if(parseFloat(puVentaRepos) > 0){
									tasaArriendo = parseFloat(puArriendo)/ parseFloat(puVentaRepos);
								}
								$("#hiddenpuVentaRepos_"+id_equipo).val(puVentaRepos);
								$("#puVentaRepos_"+id_equipo).val(formatStandar(parseFloat(puVentaRepos),nroDecimal));
								$("#hiddenpuArriendo_"+id_equipo).val(puArriendo);
								$("#puArriendo_"+id_equipo).val(formatStandar(parseFloat(puArriendo),nroDecimal));
								$("#tasaArr_"+id_equipo).val(formatPorcentaje(parseFloat(tasaArriendo) * 100));
								calculaLinea(id_equipo,nroDecimal);
							}
						}
						
					}

					sumaTotales();
					$('#tablaPrincipal').DataTable({
				    	"fixedHeader": true,
				    	"lengthMenu": [[15, 50, 100, 200, -1], [15, 50, 100, 200, "All"]],
				    	"order": [[ 0, "asc" ],[ 2, "asc" ]],
				    	"language": {
				        	"url": "https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
				        }
					});
					document.getElementById('bloquear2').style.display="none";
				}
	        });	

	}
	
	const listadoCotizaciones = () =>{
		var formData = new FormData();
		formData.append('id_sucursal',id_sucursal);
        $.ajax({
            url: "/routes2/actualizaListaCotiSelAjax/",
            type: "POST",
            method: "POST",
            data: formData,
            cache: false,
            contentType: false,
	     	processData: false,
	     	success: function(respuesta){
				document.getElementById('vistaModListaCotizacion').innerHTML = respuesta;
				$('#tablaListaCotizacion').DataTable({
				    	"fixedHeader": true,
				    	"lengthMenu": [[20, 50, 100, 200, -1], [20, 50, 100, 200, "All"]],
				    	"order": [[ 2, "desc" ],[ 1, "desc" ],[ 0, "asc" ]],
				    	"language": {
				        	"url": "https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
				        }
				} );
				$('#modalListaCotizacion').modal('show');
	     	}
        });
	}
	
	const validarForm2 = () =>{
		$("#btnSubmit2").attr('disabled',true);
		return(true);
	}
	
	
	
	let jsonDetalle = "@json";
	jsonDetalle = jsonDetalle.replace(/&quot;/g,'"');
	let arrayDetalle = JSON.parse(jsonDetalle);
	
	let arrayUnTiempo = [];
	let arrAux = [];
	@for(lista <- listUnTiempo){
		arrAux.push("@lista.id");
		arrAux.push("@lista.nombre");
		arrayUnTiempo.push(arrAux);
		arrAux = [];
	}
	
	let escondeLosM2 = '@mapPermiso.get("parametro.escondeLosM2")';
	
	const agregaNuevoEquipo = () =>{
		$("#tablaPrincipal").dataTable().fnDestroy();
		let array = [];
		for(var i=0; i < arrayDetalle.length; i++) {
				let flag = true;
				$(".idEquipo").each(function() {
					if(arrayDetalle[i][0] == $(this).val()){
						flag = false;
					}
				});
				if(flag){
						array.push(arrayDetalle[i]);
				}
		}
		$('#tablaPrincipal').DataTable({
			    	"fixedHeader": true,
			    	"lengthMenu": [[15, 50, 100, 200, -1], [15, 50, 100, 200, "All"]],
			    	"order": [[ 0, "asc" ],[ 2, "asc" ]],
			    	"language": {
			        	"url": "https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
			        }
				} );
		
		let modTable = "<table id=\"tablaSelEquipos\" class=\"table table-sm table-hover table-bordered table-condensed table-fluid\">"
			+ "<thead style=\"background-color: #eeeeee\">"
			+ "<TR><TH style=\"vertical-align: top;\">GRUPO</TH>"
			+ "<TH>CODIGO</TH><TH>EQUIPO</TH><TH>STOCK</TH><TH>SELECT</TH></TR>"
			+ "</thead><tbody>";
		for(var i=0; i < array.length; i++) {
			modTable +="<TR><td style=\"text-align:left;\">"+ array[i][23] + "</td>";
			modTable +="<td style=\"text-align:left;\">"+ array[i][1] + "</td>";
			modTable +="<td style=\"text-align:left;\">"+ array[i][2] + "</td>";
			modTable +="<td style=\"text-align:center;\"><div class=\"noprint\">"+ 
							"<a href=\"#\" onclick=\"vistaStockPorEquipo("+array[i][0]+");\" tabindex=\"-1\">"+
							"<kbd style=\"background-color: #73C6B6\">stock</kbd>"+
							"</a></div></td>";
			modTable +="<td  style=\"text-align:center;\">"+
							"<input type=\"checkbox\" id=\"sel_"+array[i][0]+"\" value =\"0\" onchange=\"seleccionaPorEq("+array[i][0]+",value)\"></td>";
			modTable +="</TR>";
		}
		modTable +="</tbody></table>";
		
		array = [];
		document.getElementById('vistalistadoEquipos').innerHTML = modTable;
		
		$('#tablaSelEquipos').DataTable({
		    	"fixedHeader": true,
		    	"lengthMenu": [[20, 50, 100, 200, -1], [20, 50, 100, 200, "All"]],
		    	"order": [[ 2, "asc" ]],
		    	"language": {
		        	"url": "https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
		        }
		  } );
		
		$('#modalListaEquipos').modal('show');
						

	}
	
	let equipSelecionados="";
	const seleccionaPorEq = (id_equipo, valor) => {
		if(valor == 0) {
			document.getElementById("sel_"+id_equipo).value = "1";
			equipSelecionados += id_equipo + ",";
		}else{
			document.getElementById("sel_"+id_equipo).value = "0";
			let aux = ""+id_equipo + ",";
			equipSelecionados = equipSelecionados.replace(aux,"");
		}
	}
	
	const agregarEquipos = (id_equipo, valor) => {
		
		if(equipSelecionados.length>0) {
			
			equipSelecionados = equipSelecionados.substring(0,equipSelecionados.length-1);
			let aux = equipSelecionados.split(",");
			equipSelecionados = "";
			
			$("#tablaPrincipal").dataTable().fnDestroy();
			let tableReg = document.getElementById("tablaPrincipal");
			
			for(var i=0; i < arrayDetalle.length; i++) {
			
				for(var j=0; j<aux.length; j++){
					
					if(arrayDetalle[i][0] == aux[j]){
						
						let row = tableReg.insertRow(2);
						
						let cell = row.insertCell(0);
						cell.style.textAlign = "left";
						cell.innerHTML = arrayDetalle[i][23];
				
						cell = row.insertCell(1);
						cell.style.textAlign = "left";
						cell.innerHTML = "<input class=\"idEquipo\" type=\"hidden\" name=\"id_equipo[]\" value=\""+arrayDetalle[i][0]+"\">"+
								"<input type=\"hidden\" name=\"id_moneda[]\" value=\""+arrayDetalle[i][8]+"\">"+
								"<a href=\"#\" onclick=\"equipoDescripcion('"+arrayDetalle[i][0]+"');\">"+arrayDetalle[i][1]+"</a>";
						
						cell = row.insertCell(2);
						cell.style.textAlign = "left";
						cell.innerHTML = "<a href=\"#\" onclick=\"equipoDescripcion('"+arrayDetalle[i][0]+"');\">"+arrayDetalle[i][2]+"</a>";
						
						cell = row.insertCell(3);
						cell.style.textAlign = "center";
						cell.innerHTML = "<div class=\"noprint\"><a href=\"#\" onclick=\"vistaStockPorEquipo('"+arrayDetalle[i][0]+"');\">"+
								"<kbd style=\"background-color: #73C6B6\">stock</kbd></a></div>";
						
						cell = row.insertCell(4);
						cell.style.textAlign = "center";
						cell.innerHTML = arrayDetalle[i][3];
									
						cell = row.insertCell(5);
						cell.style.textAlign = "center";
						cell.innerHTML = "<div style=\"display:none\" id=\"hiddencantidad_"+arrayDetalle[i][0]+"\">"+arrayDetalle[i][25]+"</div>"+
								"<input type=\"text\" class=\"cantidad form-control height23px right width80px\""+
											" name=\"cantidad[]\""+
											" id=\"cantidad_"+arrayDetalle[i][0]+"\""+
											" value=\""+arrayDetalle[i][10]+"\""+
											" onfocus=\"value=value.replace(/,/g,''); cantAux = value;\""+
											" onblur = \"value = formatStandar(value, '2');\""+
											" onkeypress=\"return ingresoDouble(event,value)\""+
											" autocomplete=\"off\""+
											" onchange=\"if(value=='') value=0; calculaLinea('"+arrayDetalle[i][0]+"', '"+arrayDetalle[i][20]+"');\">";

						cell = row.insertCell(6);
						cell.style.textAlign = "center";
						let x6 = "<input type=\"hidden\" name=\"esVenta[]\" id=\"esVenta_"+arrayDetalle[i][0]+"\"  value=\""+arrayDetalle[i][11]+"\">";
								if(arrayDetalle[i][11] == 0){
									x6 += "<input type=\"checkbox\" id=\"checkbox_"+arrayDetalle[i][0]+"\" onchange=\"checkVenta('"+arrayDetalle[i][0]+"'); calculaLinea('"+arrayDetalle[i][0]+"', '"+arrayDetalle[i][20]+"');\">";
								}else{
									x6 += "<input type=\"checkbox\" id=\"checkbox_"+arrayDetalle[i][0]+"\" onchange=\"checkVenta('"+arrayDetalle[i][0]+"'); calculaLinea('"+arrayDetalle[i][0]+"', '"+arrayDetalle[i][20]+"');\" checked>";
								}
						cell.innerHTML = x6;
						
						cell = row.insertCell(7);
						cell.style.textAlign = "center";
						cell.innerHTML = arrayDetalle[i][4];
						
						cell = row.insertCell(8);
						cell.style.textAlign = "center";
						cell.innerHTML = "<div style=\"display:none\" id=\"hiddenpuVentaRepos_"+arrayDetalle[i][0]+"\">"+arrayDetalle[i][26]+"</div>"+
									"<input type=\"text\" class=\"form-control height23px right width100px\""+
											" name=\"puVentaRepos[]\""+
											" id=\"puVentaRepos_"+arrayDetalle[i][0]+"\""+
											" value=\""+arrayDetalle[i][5]+"\""+
											" onfocus=\"value=value.replace(/,/g,'');\""+
											" onblur =\"value = formatStandar(value, '"+arrayDetalle[i][20]+"');\""+
											" onkeypress=\"return ingresoDouble(event,value)\""+
											" autocomplete=\"off\""+
											" onchange=\"if(value=='') {value=0;} else {calculaTasa(1,'"+arrayDetalle[i][0]+"', '"+arrayDetalle[i][20]+"'); calculaLinea('"+arrayDetalle[i][0]+"', '"+arrayDetalle[i][20]+"');}\">";
						
						cell = row.insertCell(9);
						cell.style.textAlign = "center";
						let x9 = "<input type=\"hidden\" id=\"id_unidadTiempo_"+arrayDetalle[i][0]+"\" name=\"id_unidadTiempo[]\" value=\""+arrayDetalle[i][9]+"\">"+
									"<select class=\"custom-select\"  style=\"width: 80px;\""+
											"onchange=\"$('#id_unidadTiempo_"+arrayDetalle[i][0]+"').val(value);\">"+
											"<option value=\""+arrayDetalle[i][9]+"\">"+arrayDetalle[i][6]+"</option>";
									for(var k=0; k<arrayUnTiempo.length; k++){
										x9 += "<option value=\""+arrayUnTiempo[k][0]+"\">"+arrayUnTiempo[k][1]+"</option>";
									}	
									x9 += "</select>";
						cell.innerHTML = x9;
										
						cell = row.insertCell(10);
						cell.innerHTML = "<div style=\"display:none\" id=\"hiddentasaArr_"+arrayDetalle[i][0]+"\">"+arrayDetalle[i][27]+"</div>"+
									"<input type=\text\" class=\"tasaGlobal form-control height23px right width80px\""+
										" id=\"tasaArr_"+arrayDetalle[i][0]+"\""+
										" value=\""+arrayDetalle[i][24]+"\""+
										" onfocus=\"value=value.replace(/,/g,'').replace(/%/g,'').replace(/ /g,'')\""+
										" onblur = \"value = formatPorcentaje(value);\""+
										" onkeypress=\"return ingresoDouble(event,value)\""+
										" autocomplete=\"off\""+
										" onchange=\"if(value=='') {value='0.00 %';} else {calculaTasa(2,'"+arrayDetalle[i][0]+"', '"+arrayDetalle[i][20]+"'); calculaLinea('"+arrayDetalle[i][0]+"', '"+arrayDetalle[i][20]+"');}\">";
											
						cell = row.insertCell(11);
						cell.style.textAlign = "center";
						cell.innerHTML = "<div style=\"display:none\" id=\"hiddenpuArriendo_"+arrayDetalle[i][0]+"\">"+arrayDetalle[i][28]+"</div>"+
										"<input type=\"text\" class=\"factorGlobal form-control height23px right width80px\""+
											" name=\"puArriendo[]\""+
											" id=\"puArriendo_"+arrayDetalle[i][0]+"\""+
											" value=\""+arrayDetalle[i][7]+"\""+
											" onfocus=\"value=value.replace(/,/g,'');\""+ 
											" onblur = \"value = formatStandar(value, '"+arrayDetalle[i][20]+"');\""+
											" onkeypress=\"return ingresoDouble(event,value)\""+
											" autocomplete=\"off\""+
											" onchange=\"if(value=='') {value=0;} else {calculaTasa(1,'"+arrayDetalle[i][0]+"', '"+arrayDetalle[i][20]+"'); calculaLinea('"+arrayDetalle[i][0]+"', '"+arrayDetalle[i][20]+"');}\">";
						
						cell = row.insertCell(12);
						cell.style.textAlign = "center";
						cell.innerHTML = "<div style=\"display:none\" id=\"hiddenpermanencia_"+arrayDetalle[i][0]+"\">"+arrayDetalle[i][29]+"</div>"+
										"<input type=\"text\" class=\"form-control height23px right\""+
											" name=\"permanencia[]\""+
											" id=\"permanencia_"+arrayDetalle[i][0]+"\""+
											" value=\""+arrayDetalle[i][12]+"\""+
											" onfocus=\"value=value.replace(/,/g,'');\""+ 
											" onblur = \"$('#hiddenpermanencia_"+arrayDetalle[i][0]+"').text(value); value = formatStandar(value, '2');\""+
											" onkeypress=\"return ingresoDouble(event,value)\""+
											" autocomplete=\"off\""+
											" onchange=\"if(value=='') value=0; calculaLinea('"+arrayDetalle[i][0]+"', '"+arrayDetalle[i][20]+"');\">";
										
						cell = row.insertCell(13);
						cell.style.textAlign = "right";
						cell.setAttribute("class","totRepos");
						cell.setAttribute("id","totRepos_"+arrayDetalle[i][0]);
						cell.innerHTML = arrayDetalle[i][13];
						
						cell = row.insertCell(14);
						cell.style.textAlign = "right";
						cell.setAttribute("class","totArrie");
						cell.setAttribute("id","totArrie_"+arrayDetalle[i][0]);
						cell.innerHTML = arrayDetalle[i][14];
						
						cell = row.insertCell(15);
						cell.style.textAlign = "right";
						cell.setAttribute("class","totVenta");
						cell.setAttribute("id","totVenta_"+arrayDetalle[i][0]);
						cell.innerHTML = arrayDetalle[i][15];
						
						cell = row.insertCell(16);
						cell.style.textAlign = "right";
						cell.setAttribute("class","totKg");
						cell.setAttribute("id","totKg_"+arrayDetalle[i][0]);
						cell.innerHTML = arrayDetalle[i][18];
						
						cell = row.insertCell(17);
						cell.style.textAlign = "right";
						cell.setAttribute("class","totM2");
						cell.setAttribute("id","totM2_"+arrayDetalle[i][0]);
						cell.innerHTML = arrayDetalle[i][19];
						if(escondeLosM2 != null && escondeLosM2 == 1){
							cell.style.display = "none";
						}
						
						cell = row.insertCell(18);
						cell.style.display = "none";
						cell.setAttribute("id","uniKg_"+arrayDetalle[i][0]);
						cell.innerHTML = arrayDetalle[i][16];
						
						cell = row.insertCell(19);
						cell.style.display = "none";
						cell.setAttribute("id","uniM2_"+arrayDetalle[i][0]);
						cell.innerHTML = arrayDetalle[i][17];
						
						cell = row.insertCell(20);
						cell.style.display = "none";
						cell.setAttribute("id","idEquipo_"+arrayDetalle[i][0]);
						cell.innerHTML = arrayDetalle[i][0];
						
						cell = row.insertCell(21);
						cell.style.display = "none";
						cell.setAttribute("id","nroDecimales_"+arrayDetalle[i][0]);
						cell.innerHTML = arrayDetalle[i][20];
					}
				}
			}
		}
		$('#tablaPrincipal').DataTable({
	    	"fixedHeader": true,
	    	"lengthMenu": [[15, 50, 100, 200, -1], [15, 50, 100, 200, "All"]],
	    	"order": [[ 0, "asc" ],[ 2, "asc" ]],
	    	"language": {
	        	"url": "https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
	        }
		} );
	}
	
	
</script>


		
		
	
