@(mapDiccionario: Map[String,String], mapPermiso: Map[String,String], userMnu: utilities.UserMnu,
listProveedor: List[tables.Proveedor], listEquipo: List[tables.Equipo], listMoneda: List[tables.Moneda], listBodegas: List[List[String]], listMon: List[tables.Moneda],
listGrupos: List[tables.Grupo], listFabrica: List[tables.Fabrica], listUnidades: List[tables.Unidad], factura: tables.Factura, detalleFactura: List[List[String]],
listSucursales: List[tables.Sucursal])

    	
@main("") {

@menues(mapDiccionario, mapPermiso, userMnu, " ")
	<form action="/compraModificaGraba/" enctype="multipart/form-data" method="POST" onsubmit="return validarForm();">
		<div id="mostrarmostrar" style="display:none;">
			@barraTitulo(mapDiccionario, "MODIFICAR COMPRA Y/O ADQUISICION","(modificar inventarios)")
			<div class="row  justify-content-md-center">
				<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
					<table class="table table-sm table-hover table-bordered table-condensed table-fluid">
						<thead style="background-color: #eeeeee">
							<tr>
								<td  width="350px">
									<div class="input-group">
								  		<div class="input-group-prepend">
								    		<span class="input-group-text" id="basic-addon1">@mapDiccionario.get("RUT") PROVEEDOR</span>
								  		</div>
								  		<input type="hidden" name="id_factura" value="@factura.getId()">
								  		<input type="hidden" name="numOcIConstruye" value="0">
								  		<input type="hidden" id="id_proveedor" name="id_proveedor" value="@factura.getId_proveedor()">
	  									<input type="text" class="form-control"
	  										id="rutProveedor"
	  										value="@factura.getRut()" 
	  										readonly>
									</div>
								</td>
								<td>
									<div class="input-group">
								  		<div class="input-group-prepend">
								    		<span class="input-group-text" id="basic-addon1">Nombre Proveedor</span>
								  		</div>
											<input type="text" class="form-control left"
												id="nombreProveedor"
												value="@factura.getNickNameProveedor()"
												required
												readonly>
									</div>
								</td>
								<td width="250px">
									<div class="input-group">
								  		<div class="input-group-prepend">
								    		<span class="input-group-text" id="basic-addon1">Nro.Documento</span>
								  		</div>
								  		<input type="text" class="form-control left"
								  				name="numeroFactura"
												id="numeroFactura"
												value = "@factura.getNumero()"
												onkeypress="return ingresoInt(event)"
												onchange="if(value!='') verificarNumeroDocumento(value)"
												autocomplete="off"
												required>
									</div>
								</td>
								<td width="230px">
									<div class="input-group">
								  		<div class="input-group-prepend">
								    		<span class="input-group-text" id="basic-addon1">Fecha</span>
								  		</div>
								  		<input type="date" class="form-control center"
								  			name="fechaFactura" 
								  			id="fechaFactura"
								  			onblur="if(!limitaFecha(value,720,10)) value='@utilities.Fechas.AAMMDD(factura.getFecha())'; else modificaFactura('fecha',value);"
								  			value="@utilities.Fechas.AAMMDD(factura.getFecha())"
						        			required>
									</div>
								</td>
								<td style="text-align:center;" width="70px">
									<span class="btn btn-info btn-sm btn-file" style="font-size: 8px;">
										@if(factura.getFacturaPDF().equals("0")){
											<div id="txtBtn">Adjuntar</div>
										}else{
											<div id="txtBtn">Cambiar</div>
										}
				    					<input type="file" id="docAdjunto" name="docAdjunto" onchange="LimitAttach(this.form, this.form.docAdjunto.value);">
									</span>
								</td>
								<td style="text-align:left;">
									@if(factura.getFacturaPDF().equals("0")){
										--
									}else{
										<a href="#" onclick="descargaDocumento('@factura.getFacturaPDF()')">
											<kbd style="background-color: #7F8C8D">doc</kbd>
										</a>
									}
								</td>
							</tr>
							<tr>
								<td colspan="7">
									<div class="input-group">
								  		<div class="input-group-prepend">
								    		<span class="input-group-text" id="basic-addon1">Observaciones</span>
								  		</div>
	  									<textarea class="form-control" 
	  										name="observaciones" 
											onchange="modificaFactura('observaciones',value)"
	  										autocomplete="off">@factura.getObservaciones()</textarea>
									</div>
								</td>
							</tr>
						</thead>
					</table>
					<hr>
					<table id="tablaPrincipal" class="table table-sm table-hover table-bordered table-condensed table-fluid">
						<thead style="background-color: #eeeeee">
							<TR>
								<TH width="10%">CODIGO</TH>
								<TH width="20%">EQUIPO</TH>
								<TH width="4%">KG</TH>
						        <TH width="4%">M2</TH>
						        <TH width="3%">UN</TH>
								<TH width="8%">CANTIDAD</TH>
								<TH width="3%">MONEDA</TH>
								<TH width="10%">P.UNITARIO<br>COMPRA</TH>
								<TH width="10%">TOTAL</TH>
								<TH width="10%">SUCURSAL</TH>
								<TH width="4%">ASIGNA<br>P.LISTA</TH>
								<TH width="15%">DESTINO</TH>
								<TH width="4%">TOT.KG</TH>
								<TH width="4%">TOT.M2</TH>
								<TH width="1%">DEL</TH>
							</TR>
						</thead>
						<tbody>
							@for((lista1, index) <- detalleFactura.zipWithIndex){
								<TR>
									<td  style="text-align:left;">@lista1.get(1)</td>
									<td  style="text-align:left;">@lista1.get(2)</td>
									<td  style="text-align:right;" id="KG_@index">@lista1.get(14)</td>
									<td  style="text-align:right;" id="M2_@index">@lista1.get(15)</td>
									<td  style="text-align:center;">@lista1.get(3)</td>
									<td  style="text-align:center;">
										<input type="text" class="cantidad form-control right"
											value="@lista1.get(4)"
											id="cantidad_@index"
											onfocus="value=value.replace(/,/g,'');" 
											onkeypress="return ingresoDouble(event,value)"
											autocomplete="off"
											onchange="if(value=='') value='@lista1.get(4)'; else modificaCompra('@lista1.get(9)','cantidad',value); actualTotales(id);" 
											@if(lista1.get(10).equals("1")){>}else{readonly>}
									</td>
									<td  style="text-align:center;">
										 <select class="form-control form-control-sm" id="idMoneda_@index" onchange="modificaCompra('@lista1.get(9)','id_moneda',value)">
											<option value="@lista1.get(5)">@lista1.get(6)</option>
							            	@for(mon <- listMoneda){
							                	<option value="@mon.getId()" >@mon.getNickName()</option>
											}
						        		</select>
									</td>
									<td  style="text-align:center;">
										<input type="text" class="form-control right"
											value="@lista1.get(7)"
											id="puCompra_@index"
											onfocus="value=value.replace(/,/g,'');" 
											onkeypress="return ingresoDouble(event,value)"
											autocomplete="off"
											onchange="if(value=='') value='@lista1.get(7)'; else modificaCompra('@lista1.get(9)','precioUnidad',value); actualTotales(id);">
									</td>
									<td  style="text-align:center;">
										<div class="total" id="total_@index" align="right">@lista1.get(8)</div>
									</td>
									<td style="text-align: left">
											 <select class="form-control form-control-sm" 
													onchange= "actualizaSucursal('@index','@lista1.get(13)',value);"
												@if(lista1.get(10).equals("1")){
													>
												}else{
													disabled>
												}
												<option value="@lista1.get(19)">@lista1.get(18)</option>
												@for(lista <- listSucursales){
													<option value="@lista.getId()">@lista.getNombre()</option>
												}
							        		</select>
									</td>
									<td style="text-align: center">
										<input type="hidden" id="id_sucursal_@index" value="@lista1.get(19)">
										<a href="#" onclick="selSucursalPrecio('@index','@lista1.get(13)')">
											<kbd style="background-color: #CACFD2">Asignar</kbd>
										</a>
									</td>
									<td  style="text-align:center;">
										<div id="selBodegaDestino_@index,">
											 <select class="form-control form-control-sm" 
													onchange= "modificaCompra('@lista1.get(9)','id_bodegaEmpresa',value)"
													onclick = "actualizaSelect('@index','@lista1.get(11)', '@lista1.get(13)');"
												@if(lista1.get(10).equals("1")){
													>
												}else{
													disabled>
												}
												<option value="@lista1.get(11)" >@lista1.get(12)</option>
							        		</select>
										</div>
									</td>
									<td><div class="kg" id="totKG_@index" align="right">@lista1.get(16)</div></td>
									<td><div class="m2" id="totM2_@index" align="right">@lista1.get(17)</div></td>
									<td style="text-align: center;">
										@if(lista1.get(10).equals("1")){
											<a href="#" onclick="eliminarFila2(this, '@lista1.get(9)')">
												<kbd style="background-color: red">X</kbd>
											</a>
										}
									</td>
								</TR>
				 			}
				 			<TR>
						        <td>
									<input type='text' class='form-control' style='background:white' 
										onclick="$('#listaEquipos').modal('show');"
										readonly>
						        </td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
							</TR>
				 			<TR style="background-color: #eeeeee">
						        <td></td>
								<td>TOTALES</td>
								<td></td>
								<td></td>
								<td></td>
								<td><div id="totalCantidad" align="right">0.00</div></td>
								<td></td>
								<td></td>
								<td><div id="totalTotal" align="right">0.00</div></td>
								<td></td>
								<td></td>
								<td></td>
								<td><div id="totalKG" align="right">0.00</div></td>
								<td><div id="totalM2" align="right">0.00</div></td>
								<td></td>
							</TR>
						</tbody>
					</table>
				</div>
			</div>
			<div class="noprint" align="left">
				<div class="row justify-content-md-center" >
					<div class="col-xs-5 col-sm-1 col-md-1 col-lg-1">
						<input type="button"  value="Cancelar" class="btn btn-light btn-sm rounded-pill btn-block" onclick="location.href='/home/';">
					</div>
					<div class="col-xs-5 col-sm-1 col-md-1 col-lg-1">
						<input type="submit"  id="aplica" value='Grabar' class="btn btn-primary btn-sm rounded-pill btn-block">
					</div>
				</div>
			</div>
		</div>
	</form>
	
	<div id='listaEquipos' class='modal' role='dialog' data-backdrop='static' data-keyboard='false'>
		<div class='modal-dialog modal-dialog-scrollable modal-lg' role='document'>
			<div class='modal-content'>
				<div class='modal-header'>
					<h5 class='modal-title'>SELECCIONAR EQUIPO</h5>
						&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
						<button type='button' class='btn btn-sm  btn-info' style='font-size: 10px;' data-dismiss='modal' onclick='$("#modalNuevoEquipo").modal("show")'>Agregar nuevo equipo</button>
				        <button type='button' class='close' data-dismiss='modal' aria-label='Close'>
				          <span aria-hidden='true'>&times;</span>
				        </button>
				</div>
				<div class='modal-body'>
					<table id="tablaListaEquipos" class='table table-sm table-bordered table-condensed table-hover table-fluid'>
						<thead style="background-color: #eeeeee">
							<TR> 
								<th>GRUPO</th>
								<th>CODIGO</th>
								<th>EQUIPO</th>
								<th>ORIGEN</th>
								
							</TR>
						</thead>
						<tbody>
							@for(lista1 <- listEquipo){
								<TR onClick="auxCodEquip='@lista1.getCodigo()'; auxNomEquip='@lista1.getNombre()'; auxKgEquip='@lista1.getKG()'; auxM2Equip='@lista1.getM2()'; 
										auxUnEquip='@lista1.getUnidad()'; selectEquipo(@lista1.getId())" data-dismiss="modal">
									<td  style="text-align:left;">@lista1.getGrupo()</td>
									<td  style="text-align:left;">@lista1.getCodigo()</td>
									<td  style="text-align:left;">@lista1.getNombre()</td>
									<td  style="text-align:left;">@lista1.getFabrica()</td>
								</TR>
				 			}
						</tbody>
					</table>
	   				<div class='row'>
						<div class='col-sm-12' style='text-align:center'>
							<button type='button' class='btn btn-sm  btn-warning' style='font-size: 10px;' data-dismiss='modal'>Cancelar</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	
	
	
	<div id='modalNuevoEquipo' class='modal' role='dialog' data-backdrop='static' data-keyboard='false'>
		<div class='modal-dialog modal-dialog-scrollable modal-sm' role='document'>
			<div class='modal-content'>
				<div class='modal-header'>
					<h5 class='modal-title'>INGRESAR NUEVO EQUIPO</h5>
					<button type='button' class='close' data-dismiss='modal' aria-label='Close'>
				          <span aria-hidden='true'>&times;</span>
				        </button>
				</div>
				<div class='modal-body'>
					<table class="table table-sm table-bordered table-condensed table-fluid">
						<TR>
							<td  style="text-align:left;">GRUPO</td>
							<td style="text-align:left">
								<select class="custom-select"
									id="nuevoEquipoId_grupo"
									required>
									@for(lista <- listGrupos){
										<option value="@lista.getId()">@lista.getNombre()</option>
									}
								</select>
							</td>
						</TR>
						<tr>
							<td style="text-align:left; vertical-align:top">CODIGO EQUIPO: </td>
							<td style="text-align:left; vertical-align:top">
								<input type="text" class="form-control left"
									id="nuevoEquipoCodigo"
									required
									autocomplete="off"
									onkeypress="return sinReservados(event)"
									onchange="value=value.replace(/\s/g,'').toUpperCase(); verificaCodigo(value)"
									maxlength="50">
							</td>
						</tr>
						<tr>
							<td style="text-align:left; vertical-align:top">NOMBRE EQUIPO: </td>
							<td style="text-align:left; vertical-align:top">
								<input type="text" class="form-control left"
									id="nuevoEquipoNombre"
									required
									autocomplete="off"
									maxlength="100">
							</td>
						</tr>
						<tr>
							<td style="text-align:left; vertical-align:top">FABRICANTE: </td>
							<td style="text-align:left; vertical-align:top">
								<select class="custom-select" 
									id="nuevoEquipoId_fabrica"
									required>
									@for(lista <- listFabrica){
										<option value="@lista.id">@lista.nickName</option>
									}
								</select>
							</td>
						</tr>
						<tr>
							<td style="text-align:left; vertical-align:top">UNIDAD: </td>
							<td style="text-align:left; vertical-align:top">
								<select class="custom-select" 
									id="nuevoEquipoId_unidad"
									required>
									@for(lista <- listUnidades){
										<option value="@lista.id">@lista.nombre</option>
									}
								</select>
							</td>
						</tr>
					</table>
					<div class='row'>
						<div class='col-sm-5' style='text-align:center'>
							<button type='button' class='btn btn-sm  btn-success' style='font-size: 10px;' onclick="grabaNuevoEquipo()">GRABAR</button>
						</div>
						<div class='col-sm-5' style='text-align:center'>
							<button type='button' class='btn btn-sm  btn-light' style='font-size: 10px;' data-dismiss='modal'>Cancelar</button>
						</div>
					</div>
			</div>
			</div>
		</div>
	</div>
	
	<div id='modalPrecioLista' class='modal' role='dialog' data-backdrop='static' data-keyboard='false'>
		<div class='modal-dialog modal-dialog-scrollable modal-md' role='document'>
			<div class='modal-content'>
				<div class='modal-header'>
					<h5 class='modal-title'>ASIGNAR/CAMBIAR PRECIO LISTA</h5>
				        <button type='button' class='close' data-dismiss='modal' aria-label='Close'>
				          <span aria-hidden='true'>&times;</span>
				        </button>
				</div>
				<div class='modal-body'>
					<div id="modalPrecios"></div>
	   				<div class='row'>
						<div class='col-sm-12' style='text-align:center'>
							<button type='button' class='btn btn-sm  btn-warning' style='font-size: 10px;' data-dismiss='modal'>CERRAR</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	
	<form class="formulario" id="formDescargaDocumento" method="post" action="/downloadPDF/">	
		<input type="hidden" id="descargaDocumento" name="nombreArchivo">
	</form>
	
	
}




<script type="text/javascript">

	$(document).ready(function() {
		
		$('#tablaListaProveedores').DataTable({
	    	"fixedHeader": true,
	    	"lengthMenu": [[20, 50, 100, 200, -1], [20, 50, 100, 200, "All"]],
	    	"order": [[ 1, "asc" ]],
	    	"language": {
	        	"url": "//cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/Spanish.json"
	        }
	  	} );
		
		$('#tablaListaEquipos').DataTable({
	    	"fixedHeader": true,
	    	"lengthMenu": [[20, 50, 100, 200, -1], [20, 50, 100, 200, "All"]],
	    	"order": [[ 1, "asc" ]],
	    	"language": {
	        	"url": "//cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/Spanish.json"
	        }
	  	} );
		  sumaTotales();
		  document.getElementById('mostrarmostrar').style.display="block";
	});
	
	const modificaFactura = (campo, valor) =>{
		var formData = new FormData();
	  	formData.append('id_factura','@factura.getId()');
	  	formData.append('campo',campo);
		formData.append('valor',valor);
        $.ajax({
            url: "/modificaFacturaPorCampoAjax/",
            type: "POST",
            method: "POST",
            data: formData,
            cache: false,
            contentType: false,
	     	processData: false,
	     	success: function(respuesta){}
        });
	}
	
	const modificaCompra = (id_compra, campo, valor) =>{
		var formData = new FormData();
	  	formData.append('id_compra',id_compra);
	  	formData.append('campo',campo);
		formData.append('valor',valor);
        $.ajax({
            url: "/modificaCompraPorCampoAjax/",
            type: "POST",
            method: "POST",
            data: formData,
            cache: false,
            contentType: false,
	     	processData: false,
	     	success: function(respuesta){}
        });
		sumaTotales();
	}
	
	const eliminarFila2 = (nodo, id_compra) =>{
		var formData = new FormData();
	  	formData.append('id_compra',id_compra);
        $.ajax({
            url: "/eliminaCompraAjax/",
            type: "POST",
            method: "POST",
            data: formData,
            cache: false,
            contentType: false,
	     	processData: false,
	     	success: function(respuesta){}
        });
		let nodoTd = nodo.parentNode.parentNode; 
		$(nodoTd).remove();
		sumaTotales();
	}
	
	const verificarNumeroDocumento = (value) =>{
		let id_proveedor = $("#id_proveedor").val();
		if(id_proveedor==0){
			alertify.alert('Primero debe seleccionar el proveedor', function () {
 				$("#numeroFactura").val("");
 			});
		}else{
			var formData = new FormData();
		  	formData.append('numeroFactura',value);
		  	formData.append('id_proveedor',id_proveedor);
	        $.ajax({
	            url: "/verificaNumeroFacturaAjax/",
	            type: "POST",
	            method: "POST",
	            data: formData,
	            cache: false,
	            contentType: false,
		     	processData: false,
		     	success: function(respuesta){
		     		if(respuesta=="existe"){
		     			alertify.alert('El número de documento ya existe para este proveedor, intente con otro', function () {
		     				$("#numeroFactura").val("@factura.getNumero()");
		     			});
		     		}else{
						modificaFactura("numero",value);
					}
		     		if(respuesta=="error"){
		     			alertify.alert(msgError, function () {
			     			location.href = "/";
			     		});
		     		}
		     	}
	        });
		}
			
	}
	
	let mapDec = new Map();
	@for(lista <- listMon){
		mapDec.set(@lista.getId(),@lista.getNumeroDecimales());
	}
	

	
	let auxCodEquip = "";
	let auxNomEquip = "";
	let auxKgEquip = "";
	let auxM2Equip = "";
	let auxUnEquip = "";
	let cont = '@detalleFactura.size()';
	
	const selectEquipo = (id_equipo) => {
		cont++;
		let tabla = document.getElementById("tablaPrincipal");
		let row = tabla.insertRow(tabla.rows.length-2);
		let cell;
		
		cell = row.insertCell(0);
		cell.style.textAlign = "left";
		cell.innerHTML = "<input type=\"hidden\" name=\"id_equipo[]\" value=\""+id_equipo+"\">"+auxCodEquip;
		
		cell = row.insertCell(1);
		cell.style.textAlign = "left";
		cell.innerHTML = auxNomEquip;
		
		cell = row.insertCell(2);
		cell.style.textAlign = "right";
		cell.innerHTML = "<div id=\"KG_"+cont+"\" align=\"right\">"+formatStandar(auxKgEquip,2)+"</div>";
		
		cell = row.insertCell(3);
		cell.style.textAlign = "right";
		cell.innerHTML = "<div id=\"M2_"+cont+"\" align=\"right\">"+formatStandar(auxM2Equip,2)+"</div>";
		
		cell = row.insertCell(4);
		cell.style.textAlign = "center";
		cell.innerHTML = auxUnEquip;
		
		cell = row.insertCell(5);
		cell.style.textAlign = "center";
		cell.innerHTML = "<input type=\"text\" class=\"cantidad form-control right\" "+
			"name=\"cantidad[]\" "+
			"id=\"cantidad_"+cont+"\" "+
			"value=\"0.00\" "+
			"onfocus=\"value=value.replace(/,/g,'');\" "+
			"onkeypress=\"return ingresoDouble(event,value)\" "+
			"autocomplete=\"off\" "+
			"onchange=\"if(value=='') value=0; value=formatStandar(value,2); actualTotales(id);\">";
		
		cell = row.insertCell(6);
		cell.style.textAlign = "center";
		let mon = "<select class=\"form-control form-control-sm\" id=\"idMoneda_"+cont+"\" name=\"id_monedaCompra[]\">";
    		@for(mon <- listMoneda){
    			mon += "<option value='@mon.getId()'>@mon.getNickName()</option>";
			}
    		mon += "</select>";
    	cell.innerHTML = mon;
	
		cell = row.insertCell(7);
		cell.style.textAlign = "center";
		cell.innerHTML = "<input type=\"text\" class=\"form-control right\" "+
			"name=\"puCompra[]\" "+
			"id=\"puCompra_"+cont+"\" "+
			"value=\"0\" "+
			"onfocus=\"value=value.replace(/,/g,'');\" "+ 
			"onkeypress=\"return ingresoDouble(event,value)\" "+
			"autocomplete=\"off\" "+
			"onchange=\"if(value=='') value=0; value=formatStandar(value,2); actualTotales(id);\"> ";
		
		cell = row.insertCell(8);
		cell.style.textAlign = "right";
		cell.innerHTML = "<div class=\"total\" id=\"total_"+cont+"\" align=\"right\">0.00</div>";
		
		cell = row.insertCell(9);
		cell.style.textAlign = "center";
		let auxSucursales = "<select class=\"form-control form-control-sm \"" +
								" onchange= \"actualizaSucursal('"+cont+"','"+id_equipo+"',value);\">" +
										"<option value='0'></option>";
												@for(lista <- listSucursales){
													auxSucursales += "<option value=\"@lista.getId()\">@lista.getNombre()</option>";
												}
							        		auxSucursales += "</select></td>";
		cell.innerHTML = auxSucursales;
		
		cell = row.insertCell(10);
		cell.style.textAlign = "center";
		cell.innerHTML = "<input type=\"hidden\" id=\"id_sucursal_"+cont+"\" value=\"0\">" +
							"<a href=\"#\" onclick=\"selSucursalPrecio("+cont+","+id_equipo+")\"> "+
							"<kbd style=\"background-color: #CACFD2\">Asignar</kbd></a>";
		cell = row.insertCell(11);
		cell.style.textAlign = "center";
		let des = "<div id='selBodegaDestino_"+cont+"'><select class=\"form-control form-control-sm\" name=\"id_bodegaDestino[]\">"+
				"<option value='0'></option>";
    		des += "</select></div>";
		cell.innerHTML = des;
			
		cell = row.insertCell(12);
		cell.style.textAlign = "right";
		cell.innerHTML = "<div class=\"kg\" id=\"totKG_"+cont+"\" align=\"right\">0.00</div>";
		
		cell = row.insertCell(13);
		cell.style.textAlign = "right";
		cell.innerHTML = "<div class=\"m2\" id=\"totM2_"+cont+"\" align=\"right\">0.00</div>";
		
		cell = row.insertCell(14);
		cell.style.textAlign = "center";
		cell.innerHTML = "<a href=\"#\" onclick= \"eliminarFila(this)\"><kbd style=\"background-color: red\">X</kbd></a>";
		
	}
	
	const eliminarFila = (nodo) =>{
		let nodoTd = nodo.parentNode.parentNode; 
		$(nodoTd).remove();
		sumaTotales();
	}
	
	const actualTotales = (id) =>{
		let aux = id.split("_");
		
		let cantidad = $("#cantidad_"+aux[1]).val().replace(/,/g,'');
		let puCompra = $("#puCompra_"+aux[1]).val().replace(/,/g,'');
		
		let id_moneda = $("#idMoneda_"+aux[1]).val();
		let nroDecimal = mapDec.get(parseFloat(id_moneda));
		
		let kg = $("#KG_"+aux[1]).text().replace(/,/g,'');
		let m2 = $("#M2_"+aux[1]).text().replace(/,/g,'');
		
		let total = parseFloat(cantidad) * parseFloat(puCompra);
		
		let totKG = parseFloat(cantidad) * parseFloat(kg);
		let totM2 = parseFloat(cantidad) * parseFloat(m2);
		$("#puCompra_"+aux[1]).val(formatStandar(puCompra,nroDecimal));
		$("#total_"+aux[1]).text(formatStandar(total,nroDecimal));
		$("#totKG_"+aux[1]).text(formatStandar(totKG,2));
		$("#totM2_"+aux[1]).text(formatStandar(totM2,2));
		sumaTotales();
	}
	
	const sumaTotales = () => {
		 let sum = 0;
			$(".cantidad").each(function() {
				let val = $(this).val().replace(/,/g,'');
				sum += parseFloat(val);
			}); $("#totalCantidad").text(formatStandar(sum,2));
			sum = 0;
			$(".total").each(function() {
				let val = $(this).text().replace(/,/g,'');
				sum += parseFloat(val);
			}); $("#totalTotal").text(formatStandar(sum,2));
			sum = 0;
			$(".kg").each(function() {
				let val = $(this).text().replace(/,/g,'');
				sum += parseFloat(val);
			}); $("#totalKG").text(formatStandar(sum,2));
			sum = 0;
			$(".m2").each(function() {
				let val = $(this).text().replace(/,/g,'');
				sum += parseFloat(val);
			}); $("#totalM2").text(formatStandar(sum,2));
	 }
	
	
	const validarForm = () =>{
		let flag = true;
		if($("#id_proveedor").val()=="0"){
			flag = false;
			alertify.alert('FALTA SELECCIONAR PROVEEDOR', function () {
				return(flag);
     		});
		}else{
			$("#tablaPrincipal").dataTable().fnDestroy();
			let tabla = document.getElementById("tablaPrincipal");
			let cantTotal = $("#totalCantidad").text().replace(/,/g,'');
			if(tabla.rows.length > 3 && parseFloat(cantTotal) > 0){
				
				flag = true;
				$(".selBodDest").each(function() {
					let val = $(this).val();
					if(val == 0){
						flag = false;
					}
				});
				
				if(flag){
					return(flag);
				}else{
					alertify.alert('PARA GRABAR UNA COMPRA TODOS LAS LINEAS DEBEN TENER UN DESTINO', function () {
						return(flag);
	     			});
				}
			}else{
				flag = false;
				alertify.alert('PARA GRABAR UNA COMPRA AL MENOS DEBE COMPRAR UN EQUIPOS', function () {
					return(flag);
	     		});
			}
		}
		return(flag);
	}
	
	const selSucursalPrecio = (index,id_equipo) => {
		let id_sucursal = $("#id_sucursal_"+index).val();
		if(id_sucursal != 0){
			var formData = new FormData();
			formData.append('id_sucursal',id_sucursal);
		  	formData.append('id_equipo',id_equipo);

	        $.ajax({
	            url: "/modalPreciosAjax/",
	            type: "POST",
	            method: "POST",
	            data: formData,
	            cache: false,
	            contentType: false,
		     	processData: false,
		     	success: function(rs1){
					$.ajax({
			            url: "/routes2/compraVistaSelBodDestAjax/",
			            type: "POST",
			            method: "POST",
			            data: formData,
			            cache: false,
			            contentType: false,
				     	processData: false,
				     	success: function(rs2){
							document.getElementById("modalPrecios").innerHTML =  rs1;
				     		$("#modalPrecioLista").modal("show");
				     	}
			        });
		     	}
	        });
		}else{
			alertify.alert("Primero debe seleccionar la Sucursal", function () {
     			});
		}
	}
	
	const actualizaSucursal = (index, auxIdEquipo, id_sucursal) =>{
		$("#modalSucursal").modal("hide");
		if(id_sucursal != 0){
			var formData = new FormData();
			formData.append('id_sucursal',id_sucursal);
		  	formData.append('id_equipo',auxIdEquipo);
	        $.ajax({
	            url: "/routes2/compraVistaSelBodDestAjax/",
	            type: "POST",
	            method: "POST",
	            data: formData,
	            cache: false,
	            contentType: false,
		     	processData: false,
		     	success: function(rs2){
		     		document.getElementById("selBodegaDestino_"+index).innerHTML =  rs2["vista"];
					$("#id_sucursal_"+index).val(id_sucursal);
		     		$("#sucursal_"+index).val(rs2["nameSucursal"]);
		     	}
	        });
		}
	}
	
	
	
	
	const actualizaSelect  = (index, id_bodega, id_equipo) => {
		var formData = new FormData();
		formData.append('id_bodega',id_bodega);
	  	formData.append('id_equipo',id_equipo);
		$.ajax({
            url: "/routes2/compraVistaSelBodDestAjax2/",
            type: "POST",
            method: "POST",
            data: formData,
            cache: false,
            contentType: false,
	     	processData: false,
	     	success: function(rs2){
	     		document.getElementById("selBodegaDestino_"+index).innerHTML =  rs2;
	     	}
        });
	}
	
	

	const cambiarPrecio = (id_sucursal, id_equipo,campo,valor) => {
		let id_moneda = $("#precioMoneda").val();
		var formData = new FormData();
		formData.append('id_sucursal',id_sucursal);
		formData.append('id_equipo',id_equipo);
		formData.append('id_moneda',id_moneda);
		formData.append('campo',campo);
		formData.append('valor',valor);
		$.ajax({
            url: "/actualizaPrecioAjax/",
            type: "POST",
            method: "POST",
            data: formData,
            cache: false,
            contentType: false,
	     	processData: false,
	     	success: function(respuesta){
	     		if(respuesta=="error"){
	     			alertify.alert(msgError, function () {
		     			location.href = "/";
		     		});
	     		}
	     		if(respuesta.status){
	     			let nroDecimal = mapDec.get(parseFloat(id_moneda));
	     			let precioVenta = $("#precioVenta").val().replace(/,/g,'');
	     			let precioArriendo = $("#precioArriendo").val().replace(/,/g,'');
	     			let precioMinimo = $("#precioMinimo").val().replace(/,/g,'');
	     			let permanenciaMinima = $("#permanenciaMinima").val().replace(/,/g,'');
	     			if(precioVenta=="") precioVenta = 0;
	     			if(precioArriendo=="") precioArriendo = 0;
	     			if(precioMinimo=="") precioMinimo = 0;
	     			if(permanenciaMinima=="") permanenciaMinima = 0;
	     			let tasa = parseFloat(precioArriendo)/parseFloat(precioVenta);
	     			if(parseFloat(precioVenta)==0) tasa = 0;
	     			$("#precioVenta").val(formatStandar(parseFloat(precioVenta),nroDecimal));
	     			$("#precioArriendo").val(formatStandar(parseFloat(precioArriendo),nroDecimal));
	     			$("#precioMinimo").val(formatStandar(parseFloat(precioMinimo),nroDecimal));
	     			$("#permanenciaMinima").val(formatStandar(parseFloat(permanenciaMinima),0));
	     			$("#precioTasa").val(formatPorcentaje(parseFloat(tasa*100)));
	     		}
	     	}
        });
	}
	
	const grabaNuevoEquipo = () =>{
		
		nuevoEquipoCodigo = $("#nuevoEquipoCodigo").val().trim();
		nuevoEquipoNombre = $("#nuevoEquipoNombre").val().trim();
		if(nuevoEquipoCodigo==""){
			alertify.alert("Debe ingresar un código de equipo", function () {
 				$("#nuevoEquipoCodigo").focus();
     		});
		}else if(nuevoEquipoNombre==""){
			alertify.alert("Debe ingresar un nombre de equipo", function () {
 				$("#nuevoEquipoNombre").focus();
     		});
		}else{
			$("#modalNuevoEquipo").modal('hide');
			let auxOpcion = document.getElementById("nuevoEquipoId_unidad");
			let auxEquipoUnidad = auxOpcion.options[auxOpcion.selectedIndex].text;
			
			var formData = new FormData();
			formData.append('id_grupo',$("#nuevoEquipoId_grupo").val());
			formData.append('codigo',$("#nuevoEquipoCodigo").val());
			formData.append('nombre',$("#nuevoEquipoNombre").val());
			formData.append('id_fabrica',$("#nuevoEquipoId_fabrica").val());
			formData.append('id_unidad',$("#nuevoEquipoId_unidad").val());
			formData.append('desdeMenu',"COMPRA");
			
			$.ajax({
	            url: "/nuevoEquipoAjax/",
	            type: "POST",
	            method: "POST",
	            data: formData,
	            cache: false,
	            contentType: false,
		     	processData: false,
		     	success: function(respuesta){
		     		if(respuesta=="existe"){
		     			alertify.alert("El código de equipo ya existe, intente con otro", function () {
		     				$("#nuevoEquipoCodigo").val("");
			     		});
		     		}else if(respuesta=="error"){
		     			alertify.alert(msgError, function () {
			     			location.href = "/";
			     		});
		     		}else{
		     			
		     			let rs = respuesta.split("_");
		     			auxCodEquip = $("#nuevoEquipoCodigo").val();
		     			auxNomEquip = $("#nuevoEquipoNombre").val();
		     			auxKgEquip = rs[1];
		     			auxM2Equip = rs[2];
		     			auxUnEquip = auxEquipoUnidad;
		     			selectEquipo(rs[0]);
		     			
		     			$("#nuevoEquipoCodigo").val("");
		     			$("#nuevoEquipoNombre").val("")
		     			
		     			
		     			
		     			
		     		}
		     	}
	        });
		}
	}
	
	const verificaCodigo = (codigo) => {
		var formData = new FormData();
	  	formData.append('codigo',codigo);
        $.ajax({
            url: "/verificaCodigoEquipoAjax/",
            type: "POST",
            method: "POST",
            data: formData,
            cache: false,
            contentType: false,
	     	processData: false,
	     	success: function(respuesta){
	     		if(respuesta=="existe"){
	     			alertify.alert("El código de equipo ya existe, intente con otro", function () {
	     				$("#nuevoEquipoCodigo").val("");
		     		});
	     		}
	     		if(respuesta=="error"){
	     			alertify.alert(msgError, function () {
		     			location.href = "/";
		     		});
	     		}
	     	}
        });
	}
	
	const descargaDocumento = (nombreDOC) => {
		  $('#descargaDocumento').val(nombreDOC);
		  document.getElementById('formDescargaDocumento').submit();
	}
	

	let extArray = new Array(".gif", ".jpg", ".png", ".jpeg", ".pdf", ".xls", ".doc", ".xlsx", ".docx", ".tar", ".zip", ".rar");
	const LimitAttach = (form, file) => {
		let allowSubmit = false;
		if (!file) return;
		while (file.indexOf("\\") != -1){
			file = file.slice(file.indexOf("\\") + 1);
		}
		let extencion = file.slice(file.lastIndexOf(".")).toLowerCase();
		for (var i = 0; i < extArray.length; i++) {
			if (extArray[i] == extencion) { allowSubmit = true; break; }
		}
		if (allowSubmit) {
			var file = $("#docAdjunto")[0].files[0];
			var fileSize = file.size; //tamaño del archivo
			if(fileSize>100000000){
				alert("Se permiten únicamente archivos que no superen los 100 MB,"
				+" el que se intenta subir pesa: "+Math.round(file.size/10)/100+" KB");
				form.docAdjunto.value="";
			}
		}else{
			alert("Se permiten únicamente archivos con la extención: " 
			+ (extArray.join("  ")) + "\nPor favor, seleccione otro archivo "
			+ "e intente de nuevo.");
			form.docAdjunto.value="";
		}
	}
	
	


	
</script>


		
		
	
